(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class E{constructor(){this.ffish=null,this.board=null,this.isReady=!1,this.onReadyCallback=null,this.moveCallback=null,this.thinking=!1,this.init()}async init(){try{let t=0;for(;(!window.Module||!window.Module.Board)&&t<200;)await new Promise(e=>setTimeout(e,50)),t++;if(!window.Module||!window.Module.Board)throw new Error("ffish Module not loaded or not ready");this.ffish=window.Module,console.log("Fairy-Stockfish info:",this.ffish.info()),console.log("Available variants:",this.ffish.variants()),this.loadMetricChessVariant();try{this.ffish.setOptionInt("Threads",navigator.hardwareConcurrency||4),console.log(`Multithreading enabled with ${navigator.hardwareConcurrency||4} threads`)}catch(e){console.log("Multithreading not available:",e.message)}this.isReady=!0,console.log("Fairy-Stockfish initialized successfully with Metric Chess variant"),this.onReadyCallback&&this.onReadyCallback()}catch(t){console.error("Failed to initialize Fairy-Stockfish:",t)}}loadMetricChessVariant(){const t=`
# Metric Chess - 10x10 variant with trebuchets
[metricchess:chess]
maxRank = 10
maxFile = 10
startFen = trnbqkbnrt/pppppppppp/10/10/10/10/10/10/PPPPPPPPPP/TRNBQKBNRT w - - 0 1
promotionRank = 10
promotionPieceTypes = q r b n t k
doubleStep = true
doubleStepRank = 2
doubleStepRankMin = 2
castling = true
castlingKingSide = true
castlingQueenSide = true
# Trebuchet piece that moves exactly distance 3 (Chebyshev distance)
customPiece1 = t:mQ3
pieceToCharTable = PNBRQ..........Kpnbrq..........k......T.......t
`;try{this.ffish.loadVariantConfig(t),console.log("Metric Chess variant configuration loaded successfully")}catch(e){console.error("Failed to load Metric Chess variant:",e)}}onReady(t){this.onReadyCallback=t,this.isReady&&t()}setPosition(t){if(this.isReady)try{this.board&&this.board.delete(),this.board=new this.ffish.Board("metricchess",t||void 0),console.log("Position set:",this.board.fen())}catch(e){console.error("Error setting position:",e)}}getLegalMoves(){if(this.board){const t=this.board.legalMoves();return t?t.split(" ").filter(e=>e.length>0):[]}return[]}makeMove(t){return this.board?this.board.push(t):!1}getFen(){return this.board?this.board.fen():null}isGameOver(){return this.board?this.board.isGameOver():!1}getResult(){return this.board?this.board.result():"*"}async go(t=3e3,e){if(!this.isReady||!this.board||this.thinking){console.log("Cannot make AI move:",{isReady:this.isReady,hasBoard:!!this.board,thinking:this.thinking});return}this.thinking=!0,this.moveCallback=e;try{if(typeof this.board.go=="function"){console.log("Using Fairy-Stockfish built-in search");const o={movetime:t,threads:navigator.hardwareConcurrency||4,depth:20};this.board.go(o,i=>{this.thinking=!1,console.log("Fairy-Stockfish search result:",i),i&&i.bestmove?this.moveCallback(i.bestmove):(console.warn("No bestmove from Fairy-Stockfish, falling back to custom search"),this.fallbackSearch(t,e))})}else throw new Error("Built-in search not available")}catch(o){console.log("Built-in search failed, using custom iterative deepening:",o.message),this.fallbackSearch(t,e)}}fallbackSearch(t,e){setTimeout(()=>{try{const o=this.findBestMoveIterativeDeepening(t);this.thinking=!1,console.log("AI selected move (fallback):",o),o&&this.moveCallback&&this.moveCallback(o)}catch(o){console.error("Error in fallback search:",o),this.thinking=!1}},100)}findBestMoveIterativeDeepening(t){const e=this.getLegalMoves();if(console.log("Legal moves from ffish:",e),e.length===0)return console.warn("No legal moves available"),null;const o=this.prioritizeMoves(e),i=Date.now();let r=null,s=-1/0,n=1;for(;Date.now()-i<t;){let l=null,a=-1/0;for(const c of o){if(Date.now()-i>=t)break;this.board.push(c);const h=this.minimax(n-1,-1/0,1/0,!1);this.board.pop(),h>a&&(a=h,l=c)}if(l&&Date.now()-i<t)r=l,s=a,console.log(`Depth ${n} completed, best move: ${r}, score: ${s}`);else break;n++}return console.log(`Time-based search completed at depth ${n-1}, selected move: ${r}, score: ${s}`),r}prioritizeMoves(t){return t.sort((e,o)=>{const i=this.scoreMove(e);return this.scoreMove(o)-i})}scoreMove(t){let e=0;if(this.board.isCapture(t)){e+=20;const f=this.board.fen().split(" ")[0].split("/"),b=parseInt(t[1])-1,y=f[9-b];let u=0,w=null;for(const k of y)if(k>="1"&&k<="9")u+=parseInt(k);else{if(u===t.charCodeAt(0)-97){w=k;break}u++}w&&w.toLowerCase()==="t"&&(e+=15)}this.board.push(t),this.board.isCheck()&&(e+=15),this.board.pop();const o=t.charCodeAt(2)-97;o>=3&&o<=6&&(e+=3);const i=parseInt(t[3])-1;i>=6?e+=2:i>=4&&(e+=1);const n=this.board.fen().split(" ")[0].split("/"),l=parseInt(t[1])-1,a=n[9-l];let c=0,h=null;for(const d of a)if(d>="1"&&d<="9")c+=parseInt(d);else{if(c===t.charCodeAt(0)-97){h=d;break}c++}return h&&h.toLowerCase()==="t"&&(e+=5),h&&h.toLowerCase()==="q"&&(e+=2),e}minimax(t,e,o,i){if(t===0||this.board.isGameOver())return this.evaluatePosition();const r=this.getLegalMoves();if(i){let s=-1/0;for(const n of r){this.board.push(n);const l=this.minimax(t-1,e,o,!1);if(this.board.pop(),s=Math.max(s,l),e=Math.max(e,l),o<=e)break}return s}else{let s=1/0;for(const n of r){this.board.push(n);const l=this.minimax(t-1,e,o,!0);if(this.board.pop(),s=Math.min(s,l),o=Math.min(o,l),o<=e)break}return s}}evaluatePosition(){const e=this.board.fen().split(" ")[0],o={p:-1,n:-3,b:-3,r:-5,q:-9,t:-10,k:0,P:1,N:3,B:3,R:5,Q:9,T:10,K:0};let i=0,r=0,s=0,n=0,l=0,a=0,c=0;const h=e.split("/");for(let f=0;f<10;f++){const b=h[f];let y=0;for(const u of b)u>="1"&&u<="9"?y+=parseInt(u):(o[u]!==void 0&&(i+=o[u],u==="T"&&r++,u==="t"&&s++,y>=3&&y<=6&&(u===u.toUpperCase()&&u!=="K"?(a+=.3,n+=.2):u===u.toLowerCase()&&u!=="k"&&(c-=.3,l-=.2)),u===u.toUpperCase()&&u!=="K"?f>=6?n+=.5:f>=4&&(n+=.2):u===u.toLowerCase()&&u!=="k"&&(f<=3?l-=.5:f<=5&&(l-=.2)),["Q","R","B","N","T"].includes(u.toUpperCase())&&f>=2&&f<=7&&y>=2&&y<=7&&(u===u.toUpperCase()?n+=.3:l-=.3)),y++)}r>=2&&(i+=5),s>=2&&(i-=5),r===1&&(i+=2),s===1&&(i-=2),i+=n-l,i+=(a-c)*2;const d=this.isKingExposed(!0),p=this.isKingExposed(!1);return d&&(i-=1),p&&(i+=1),i+=(n-l)*.5,i+=Math.random()*.05-.025,i}isKingExposed(t){const o=this.board.fen().split(" ")[0];return t?o.includes("K")&&["d","e","f"].some(i=>o.includes(`K${i}`)||o.includes(`${i}K`)):o.includes("k")&&["d","e","f"].some(i=>o.includes(`k${i}`)||o.includes(`${i}k`))}stop(){this.thinking=!1}quit(){this.board&&(this.board.delete(),this.board=null)}}const S={king:"fa-chess-king",heir:"fa-chess-king",queen:"fa-chess-queen",rook:"fa-chess-rook",bishop:"fa-chess-bishop",knight:"fa-chess-knight",pawn:"fa-chess-pawn",trebuchet:"fa-tower-observation"},A={king:[{dx:-1,dy:-1},{dx:-1,dy:0},{dx:-1,dy:1},{dx:0,dy:-1},{dx:0,dy:1},{dx:1,dy:-1},{dx:1,dy:0},{dx:1,dy:1}],heir:[{dx:-1,dy:-1},{dx:-1,dy:0},{dx:-1,dy:1},{dx:0,dy:-1},{dx:0,dy:1},{dx:1,dy:-1},{dx:1,dy:0},{dx:1,dy:1}],queen:[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],rook:[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}],bishop:[{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],knight:[{dx:-2,dy:-1},{dx:-2,dy:1},{dx:-1,dy:-2},{dx:-1,dy:2},{dx:1,dy:-2},{dx:1,dy:2},{dx:2,dy:-1},{dx:2,dy:1}],pawn:{white:[{dx:0,dy:1},{dx:0,dy:2}],black:[{dx:0,dy:-1},{dx:0,dy:-2}]}};class P{constructor(){this.board=Array(10).fill().map(()=>Array(10).fill(null)),this.currentPlayer="white",this.gameHistory=[],this.redoStack=[],this.capturedPieces={white:[],black:[]},this.moveCount=0,this.moveNotation=[],this.bottomPlayerType="human",this.topPlayerType="human",this.whitePosition="bottom",this.aiTimeLimit=3e3,this.aiEngine=new E,this.reset()}reset(){this.board=Array(10).fill().map(()=>Array(10).fill(null)),this.currentPlayer="white",this.gameHistory=[],this.redoStack=[],this.capturedPieces={white:[],black:[]},this.moveCount=0,this.moveNotation=[],this.board[0][0]={type:"trebuchet",color:"white"},this.board[0][1]={type:"rook",color:"white"},this.board[0][2]={type:"knight",color:"white"},this.board[0][3]={type:"bishop",color:"white"},this.board[0][4]={type:"queen",color:"white"},this.board[0][5]={type:"king",color:"white"},this.board[0][6]={type:"bishop",color:"white"},this.board[0][7]={type:"knight",color:"white"},this.board[0][8]={type:"rook",color:"white"},this.board[0][9]={type:"trebuchet",color:"white"};for(let t=0;t<10;t++)this.board[1][t]={type:"pawn",color:"white"};this.board[9][0]={type:"trebuchet",color:"black"},this.board[9][1]={type:"rook",color:"black"},this.board[9][2]={type:"knight",color:"black"},this.board[9][3]={type:"bishop",color:"black"},this.board[9][4]={type:"queen",color:"black"},this.board[9][5]={type:"king",color:"black"},this.board[9][6]={type:"bishop",color:"black"},this.board[9][7]={type:"knight",color:"black"},this.board[9][8]={type:"rook",color:"black"},this.board[9][9]={type:"trebuchet",color:"black"};for(let t=0;t<10;t++)this.board[8][t]={type:"pawn",color:"black"};this.initialBoard=this.board.map(t=>[...t])}getPseudoLegalMoves(t,e){const o=this.board[e][t];if(!o)return[];const i=[];if(o.type==="trebuchet")i.push(...this.getTrebuchetMoves(t,e));else if(o.type==="pawn")i.push(...this.getPawnMoves(t,e));else{const r=A[o.type];for(const s of r){let n=s.dx,l=s.dy,a=t+n,c=e+l;if(a<0||a>=10||c<0||c>=10)continue;const h=this.board[c][a];if(["queen","rook","bishop"].includes(o.type)){let d=this.getSlidingMoves(t,e,n,l);i.push(...d)}else if(!h||h.color!==o.color){let d={file:a,rank:c,capture:!!h};(o.type==="king"||o.type==="heir")&&this.isAdjacentToAnyKing(a,c)||i.push(d)}}}return i}getAvailableMoves(t,e){const o=this.getPseudoLegalMoves(t,e);return this.countKings(this.currentPlayer)>1?o:o.filter(r=>{const s=this.board.map(a=>[...a]),n=this.currentPlayer;this.board[r.rank][r.file]=this.board[e][t],this.board[e][t]=null;const l=this.isCheck();return this.board=s,this.currentPlayer=n,!l})}getSlidingMoves(t,e,o,i){const r=[],s=this.board[e][t];for(let n=1;n<10;n++){const l=t+o*n,a=e+i*n;if(l<0||l>=10||a<0||a>=10)break;const c=this.board[a][l];if(!c)r.push({file:l,rank:a,capture:!1});else{c.color!==s.color&&r.push({file:l,rank:a,capture:!0});break}}return r}getTrebuchetMoves(t,e){const o=[],i=this.board[e][t];for(let r=0;r<10;r++)for(let s=0;s<10;s++){const n=Math.abs(r-t),l=Math.abs(s-e);if(Math.max(n,l)===3&&!(n===0&&l===0)){const c=this.board[s][r];(!c||c.color!==i.color)&&o.push({file:r,rank:s,capture:!!c})}}return o}getPawnMoves(t,e){const o=[],i=this.board[e][t],r=i.color==="white"?1:-1,s=e+r;if(s>=0&&s<10&&!this.board[s][t]){o.push({file:t,rank:s,capture:!1});const l=e+r*2;l>=0&&l<10&&!this.board[l][t]&&o.push({file:t,rank:l,capture:!1})}const n=[t-1,t+1];for(const l of n)if(l>=0&&l<10){const a=e+r;if(a>=0&&a<10){const c=this.board[a][l];c&&c.color!==i.color&&o.push({file:l,rank:a,capture:!0})}}return o}movePiece(t,e,o,i,r=null){const s=this.board[e][t];if(!s||!this.getAvailableMoves(t,e).some(h=>h.file===o&&h.rank===i))return!1;const a=this.generateMoveNotation(s,t,e,o,i);this.board[i][o]=s,this.board[e][t]=null,s.type==="pawn"&&(s.color==="white"&&i===9||s.color==="black"&&i===0)&&(r?s.type=r:s.type="queen");const c=this.board[i][o];return c&&c.color!==s.color&&this.capturedPieces[s.color].push(c),this.moveNotation.push({moveNumber:Math.floor(this.moveCount/2)+1,player:this.currentPlayer,notation:a}),this.gameHistory.push({board:this.board.map(h=>[...h]),currentPlayer:this.currentPlayer,moveCount:this.moveCount,capturedPieces:{...this.capturedPieces},notation:[...this.moveNotation],fromFile:t,fromRank:e,toFile:o,toRank:i}),this.redoStack=[],this.currentPlayer=this.currentPlayer==="white"?"black":"white",this.moveCount++,!0}undoMove(){if(this.gameHistory.length===0)return!1;const t=this.gameHistory.pop();if(this.redoStack.push(t),this.gameHistory.length>0){const e=this.gameHistory[this.gameHistory.length-1];this.board=e.board.map(o=>[...o]),this.currentPlayer=e.currentPlayer,this.moveCount=e.moveCount,this.capturedPieces={...e.capturedPieces},this.moveNotation=[...e.notation]}else this.board=this.initialBoard.map(e=>[...e]),this.currentPlayer="white",this.moveCount=0,this.capturedPieces={white:[],black:[]},this.moveNotation=[];return!0}redoMove(){if(this.redoStack.length===0)return!1;const t=this.redoStack.pop();return this.board=t.board.map(e=>[...e]),this.currentPlayer=t.currentPlayer,this.moveCount=t.moveCount,this.capturedPieces={...t.capturedPieces},this.moveNotation=[...t.notation],this.gameHistory.push(t),this.currentPlayer=this.currentPlayer==="white"?"black":"white",this.moveCount++,!0}generateMoveNotation(t,e,o,i,r){const s=t.type.charAt(0).toUpperCase(),n=`${e}${o}`,l=`${i}${r}`,a=this.board[r][i];return a&&a.color!==t.color?`${s}${n}x${l}`:`${s}${n}-${l}`}isCheck(){if(this.countKings(this.currentPlayer)!==1)return!1;let e,o;for(let i=0;i<10;i++)for(let r=0;r<10;r++){const s=this.board[i][r];if(s&&(s.type==="king"||s.type==="heir")&&s.color===this.currentPlayer){e=r,o=i;break}}if(e===void 0||o===void 0)return!1;for(let i=0;i<10;i++)for(let r=0;r<10;r++){const s=this.board[i][r];if(s&&s.color!==this.currentPlayer&&this.getPseudoLegalMoves(r,i).some(a=>a.file===e&&a.rank===o))return!0}return!1}isCheckmate(){if(!this.isCheck())return!1;for(let t=0;t<10;t++)for(let e=0;e<10;e++){const o=this.board[t][e];if(o&&o.color===this.currentPlayer&&this.getAvailableMoves(e,t).length>0)return!1}return!0}isStalemate(){if(this.isCheck())return!1;for(let t=0;t<10;t++)for(let e=0;e<10;e++){const o=this.board[t][e];if(o&&o.color===this.currentPlayer&&this.getAvailableMoves(e,t).length>0)return!1}return!0}getPieceIcon(t){return t?S[t.type]:null}countKings(t){let e=0;for(let o=0;o<10;o++)for(let i=0;i<10;i++){const r=this.board[o][i];r&&r.color===t&&(r.type==="king"||r.type==="heir")&&e++}return e}isAdjacentToAnyKing(t,e){for(let o=-1;o<=1;o++)for(let i=-1;i<=1;i++){if(o===0&&i===0)continue;const r=e+o,s=t+i;if(r>=0&&r<10&&s>=0&&s<10){const n=this.board[r][s];if(n&&(n.type==="king"||n.type==="heir"))return!0}}return!1}generateFEN(){let t="";for(let e=9;e>=0;e--){let o=0;for(let i=0;i<10;i++){const r=this.board[e][i];if(r){o>0&&(t+=o,o=0);let s=r.type.charAt(0).toUpperCase();r.type==="knight"&&(s="N"),r.type==="trebuchet"&&(s="T"),r.type==="heir"&&(s="H"),t+=r.color==="white"?s:s.toLowerCase()}else o++}o>0&&(t+=o),e>0&&(t+="/")}return t+=` ${this.currentPlayer.charAt(0)}`,t+=" -",t+=" -",t+=` 0 ${Math.floor(this.moveCount/2)+1}`,t}getAIMove(t){const e=this.generateFEN();console.log("Setting FEN for AI:",e),this.aiEngine.setPosition(e),this.aiEngine.go(this.aiTimeLimit,o=>{console.log("Raw UCI move from ffish:",o);const i=o.match(/^([a-j])(\d+)([a-j])(\d+)/);if(!i){console.error("Invalid UCI move format:",o),t({fromFile:NaN,fromRank:NaN,toFile:NaN,toRank:NaN});return}const r=i[1].charCodeAt(0)-97,s=parseInt(i[2])-1,n=i[3].charCodeAt(0)-97,l=parseInt(i[4])-1;console.log("Parsed move:",{fromFile:r,fromRank:s,toFile:n,toRank:l}),t({fromFile:r,fromRank:s,toFile:n,toRank:l})})}displayBoardCompact(){console.log("Compact Text Board (0-9 at bottom and left):");for(let t=9;t>=0;t--){let e=t+" ";for(let o=0;o<10;o++){const i=this.board[t][o];if(i){let r;i.type==="knight"?r="n":r=i.type.charAt(0),e+=(i.color==="white"?r.toLowerCase():r.toUpperCase())+" "}else e+=". "}console.log(e)}console.log("  0 1 2 3 4 5 6 7 8 9"),console.log(`
Piece Legend:`),console.log("Lowercase = White pieces: t=trebuchet, r=rook, n=knight, b=bishop, q=queen, k=king, p=pawn"),console.log("Uppercase = Black pieces: T=trebuchet, R=rook, N=knight, B=bishop, Q=queen, K=king, P=pawn"),console.log(". = Empty square")}rotateGrid(t,e){const o=(e%360+360)%360;if(![0,90,180,270].includes(o))throw new Error("Rotation must be a multiple of 90 degrees (0, 90, 180, 270)");const i=12,r=o/90;let s=t.map(n=>[...n]);for(let n=0;n<r;n++){const l=Array.from({length:i},()=>Array(i).fill(null));for(let a=0;a<i;a++)for(let c=0;c<i;c++)l[a][i-1-c]=s[c][a];s=l}return s}displayBoardWithOrientation(t){console.log(`Compact Text Board (Orientation: ${t}):`);const e=Array(12).fill().map(()=>Array(12).fill(null));for(let s=0;s<10;s++)for(let n=0;n<10;n++){const l=10-s,a=n+1;this.board[s][n]?e[l][a]=this.board[s][n]:(n+s)%2===1?e[l][a]="·":e[l][a]=null}for(let s=0;s<10;s++)e[11][s+1]=String(s);for(let s=0;s<10;s++)e[s+1][0]=String(9-s);e[0][0]="D",e[11][11]="D",e[0][11]="L",e[11][0]="L";const i={bottom:0,left:90,top:180,right:270}[t]||0;console.log(`Rotation: ${i}° clockwise`);const r=this.rotateGrid(e,i);for(let s=0;s<12;s++){let n="";for(let l=0;l<12;l++){const a=r[s][l];if(a===null)n+="  ";else if(typeof a=="string")n+=a+" ";else if(a){let c;a.type==="knight"?c="n":c=a.type.charAt(0),n+=(a.color==="white"?c.toLowerCase():c.toUpperCase())+" "}else a==="·"?n+="· ":n+="  "}console.log(n.trimEnd())}console.log(`
Piece Legend:`),console.log("Lowercase = White pieces: t=trebuchet, r=rook, n=knight, b=bishop, q=queen, k=king, p=pawn"),console.log("Uppercase = Black pieces: T=trebuchet, R=rook, N=knight, B=bishop, Q=queen, K=king, P=pawn"),console.log("· = Empty dark square, D/L = Corner square colors (Dark/Light)")}}let g={kitCode:null,stylePrefix:"fa-solid",icons:{pieces:{king:"fa-chess-king",heir:"fa-chess-king",queen:"fa-chess-queen",rook:"fa-chess-rook",bishop:"fa-chess-bishop",knight:"fa-chess-knight",pawn:"fa-chess-pawn",trebuchet:"fa-meteor"},ui:{whiteSpinner:"fa-atom",blackSpinner:"fa-atom",newGame:"fa-plus-circle",resetGame:"fa-refresh",undoMove:"fa-undo",redoMove:"fa-redo",resignGame:"fa-flag",rotateLeft:"fa-arrow-left",rotateRight:"fa-arrow-right",toggleAudio:"fa-volume-up",chessBoard:"fa-chess-board",trebuchetFeature:"fa-meteor",heirFeature:"fa-crown",aiFeature:"fa-brain",undoFeature:"fa-undo",responsiveFeature:"fa-mobile-alt"}}};async function x(){var m;try{const t=await fetch("metric-chess.json");if(!t.ok)throw new Error(`HTTP ${t.status}`);const e=await t.json();if(e.fontAwesomeKit&&typeof e.fontAwesomeKit=="string"&&e.fontAwesomeKit.trim()){g.kitCode=e.fontAwesomeKit.trim(),g.stylePrefix=((m=e.fontAwesomeStyle)==null?void 0:m.trim())||"fa-duotone";const o=document.createElement("script");o.src=`https://kit.fontawesome.com/${g.kitCode}.js`,o.crossOrigin="anonymous",o.async=!0,o.onload=()=>console.log("Font Awesome Pro kit loaded:",g.stylePrefix),o.onerror=()=>console.warn("Failed to load Font Awesome kit"),document.head.appendChild(o)}else{console.log("No valid Font Awesome kit found in config — using free icons"),g.stylePrefix="fa-solid";const o=document.createElement("link");o.rel="stylesheet",o.href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css",document.head.appendChild(o)}e.fontAwesomeKit&&typeof e.fontAwesomeKit=="string"&&e.fontAwesomeKit.trim()&&e.icons&&(e.icons.pieces&&(g.icons.pieces={...g.icons.pieces,...e.icons.pieces}),e.icons.ui&&(g.icons.ui={...g.icons.ui,...e.icons.ui}))}catch{console.log("No metric-chess.json found or error loading it — using free Font Awesome");const e=document.createElement("link");e.rel="stylesheet",e.href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css",document.head.appendChild(e)}return g}function v(){return g.stylePrefix}function M(m){return g.icons.pieces[m]||"fa-question"}function C(m){return g.icons.ui[m]||"fa-question"}window.getFAIconPrefix=v;window.getPieceIcon=M;window.getUIIcon=C;class T{constructor(){this.boardElement=document.getElementById("chessBoard"),this.chessGame=new P,this.lastMovedPiece=null}initializeBoard(){this.boardElement.innerHTML="";for(let t=9;t>=0;t--)for(let e=0;e<10;e++){const o=document.createElement("div");o.className="cell",o.dataset.coord=`${e}${t}`,(e+t)%2===1?o.classList.add("dark-square"):o.classList.add("light-square"),this.boardElement.appendChild(o)}}updateSquareColors(t="bottom"){const e=Array(12).fill().map(()=>Array(12).fill(null));for(let s=0;s<10;s++)for(let n=0;n<10;n++){const l=10-s,a=n+1;(n+s)%2===1?e[l][a]="·":e[l][a]=null}e[0][0]="D",e[11][11]="D",e[0][11]="L",e[11][0]="L";const i={bottom:0,left:90,top:180,right:270}[t]||0,r=this.chessGame.rotateGrid(e,i);for(let s=0;s<12;s++)for(let n=0;n<12;n++){const l=r[s][n];if(n>=1&&n<=10&&s>=1&&s<=10){const a=n-1,c=10-s,h=this.getCellElement(a,c);if(!h)continue;h.classList.remove("light-square","dark-square"),l==="·"?h.classList.add("dark-square"):l===null&&h.classList.add("light-square")}}}renderBoard(t){document.querySelectorAll(".chess-piece").forEach(a=>a.remove());const o=t.whitePosition||"bottom",i=t.board;this.updateCoordinateLabels(o);const r=Array(12).fill().map(()=>Array(12).fill(null));for(let a=0;a<10;a++)for(let c=0;c<10;c++){const h=10-a,d=c+1;if(i[a][c]){const p=i[a][c];r[h][d]={piece:p,originalFile:c,originalRank:a,type:"piece"}}else(c+a)%2===1?r[h][d]="·":r[h][d]=null}const n={bottom:0,left:90,top:180,right:270}[o]||0,l=this.chessGame.rotateGrid(r,n);for(let a=0;a<12;a++)for(let c=0;c<12;c++){const h=l[a][c];if(c>=1&&c<=10&&a>=1&&a<=10){const d=c-1,p=10-a,f=this.getCellElement(d,p);if(!f)continue;const b=f.querySelector(".chess-piece");if(b&&b.remove(),f.classList.remove("light-square","dark-square"),h==="·")f.classList.add("dark-square");else if(h===null)f.classList.add("light-square");else if(h&&typeof h=="object"&&h.type==="piece"){const y=h.originalFile,u=h.originalRank;(y+u)%2===1?f.classList.add("dark-square"):f.classList.add("light-square"),this.renderPiece(d,p,h.piece)}}}}renderPiece(t,e,o){const i=this.getCellElement(t,e);if(!i)return;const r=i.querySelector(".chess-piece");r&&r.remove();const s=document.createElement("i");s.className=`${v()} ${this.getPieceIcon(o.type)} chess-piece ${o.color}`,s.dataset.piece=o.type,s.dataset.color=o.color,this.lastMovedPiece&&this.lastMovedPiece.file===t&&this.lastMovedPiece.rank===e&&s.classList.add("last-moved"),i.appendChild(s)}getPieceIcon(t){return M(t)}getCellElement(t,e){return document.querySelector(`.cell[data-coord="${t}${e}"]`)}highlightPiece(t,e,o){const i=this.getCellElement(t,e);i&&i.classList.add(o)}highlightMoves(t,e="bottom"){this.clearMoveHighlights();const o=Array(12).fill().map(()=>Array(12).fill(null));t.forEach(n=>{const l=10-n.rank,a=n.file+1;o[l][a]=n});const r={bottom:0,left:90,top:180,right:270}[e]||0,s=this.chessGame.rotateGrid(o,r);for(let n=0;n<12;n++)for(let l=0;l<12;l++){const a=s[n][l];if(a&&typeof a=="object"&&a.file!==void 0&&a.rank!==void 0&&l>=1&&l<=10&&n>=1&&n<=10){const c=l-1,h=10-n,d=this.getCellElement(c,h);if(d){const p=document.createElement("div");p.className=`highlight ${a.capture?"capture-move":"available-move"}`,d.appendChild(p)}}}}clearHighlights(){this.clearSelectionHighlights(),this.clearMoveHighlights()}clearSelectionHighlights(){document.querySelectorAll(".selected-piece").forEach(e=>{e.classList.remove("selected-piece")})}clearMoveHighlights(){document.querySelectorAll(".highlight").forEach(e=>{e.remove()})}updateCoordinateLabels(t="bottom"){const e=Array(12).fill().map(()=>Array(12).fill(null));for(let s=0;s<10;s++)e[11][s+1]=String(s);for(let s=0;s<10;s++)e[s+1][0]=String(9-s);e[0][0]="D",e[11][11]="D",e[0][11]="L",e[11][0]="L";const i={bottom:0,left:90,top:180,right:270}[t]||0,r=this.chessGame.rotateGrid(e,i);this.updateLabelElements(r,t)}updateLabelElements(t,e){document.querySelectorAll(".coordinate-labels").forEach(s=>s.style.display="none");const i={bottom:["bottom","left"],left:["left","top"],top:["top","right"],right:["right","bottom"]}[e]||["bottom","left"],r={bottom:t[11].slice(1,11).map(s=>s||""),left:t.slice(1,11).map(s=>s[0]||""),top:t[0].slice(1,11).map(s=>s||""),right:t.slice(1,11).map(s=>s[11]||"")};i.forEach(s=>{s==="bottom"||s==="top"?this.updateFileLabels(`.file-labels.${s}`,r[s]):this.updateRankLabels(`.rank-labels.${s}`,r[s]),document.querySelector(`.${s==="bottom"||s==="top"?"file":"rank"}-labels.${s}`).style.display="flex"})}updateFileLabels(t,e){const o=document.querySelector(t);if(!o)return;const i=o.querySelectorAll(".file-label");for(let r=0;r<i.length&&r<e.length;r++)i[r].textContent=e[r]}updateRankLabels(t,e){const o=document.querySelector(t);if(!o)return;const i=o.querySelectorAll(".rank-label");for(let r=0;r<i.length&&r<e.length;r++)i[r].textContent=e[r]}}class I{constructor(){this.initializeApp()}async initializeApp(){await x(),this.updateStaticIcons(),this.game=new P,this.renderer=new T,this.selectedPiece=null,this.availableMoves=[],this.audioEnabled=!0,this.lastMovedPiece=null,this.game.bottomPlayerType="human",this.game.topPlayerType="ai",this.game.whitePosition="bottom",this.setupModalEventListeners(),this.initialize(),this.showWelcomeModal()}initialize(){this.renderer.initializeBoard(),this.renderer.renderBoard(this.game),this.setupEventListeners(),this.updateGameStatus(),this.updateButtonStates(),this.checkForAIMove(),this.initializeTooltips()}setupEventListeners(){document.getElementById("chessBoard").addEventListener("click",t=>{const e=t.target.closest(".cell");if(!e)return;const o=e.dataset.coord,i=parseInt(o[0]),r=parseInt(o[1]);this.handleCellClick(i,r)}),document.getElementById("resetGame").addEventListener("click",()=>{this.game.reset(),this.lastMovedPiece=null,this.renderer.lastMovedPiece=null,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates()}),document.getElementById("undoMove").addEventListener("click",()=>{const t=this.game.gameHistory[this.game.gameHistory.length-1];if(this.game.undoMove(),t){const e=this.transformBoardToScreenCoords(t.fromFile,t.fromRank);this.lastMovedPiece={file:e.screenFile,rank:e.screenRank}}else this.lastMovedPiece=null;this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates()}),document.getElementById("redoMove").addEventListener("click",()=>{const t=this.game.redoStack[this.game.redoStack.length-1];if(this.game.redoMove(),t){const e=this.transformBoardToScreenCoords(t.toFile,t.toRank);this.lastMovedPiece={file:e.screenFile,rank:e.screenRank}}else this.lastMovedPiece=null;this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates()}),document.getElementById("newGame").addEventListener("click",()=>{this.showGameSetupModal()}),document.getElementById("rotateLeft").addEventListener("click",()=>{this.rotateOrientation("left")}),document.getElementById("rotateRight").addEventListener("click",()=>{this.rotateOrientation("right")}),document.getElementById("resignGame").addEventListener("click",()=>{this.resignGame()}),document.getElementById("toggleAudio").addEventListener("click",()=>{this.toggleAudio()}),document.getElementById("startGame").addEventListener("click",()=>{this.startNewGame()}),document.getElementById("cancelGame").addEventListener("click",()=>{this.hideGameSetupModal()}),document.querySelectorAll(".promotion-piece").forEach(t=>{t.addEventListener("click",e=>{const o=e.currentTarget.dataset.piece;this.completePromotion(o)})})}setupModalEventListeners(){document.getElementById("startWelcomeGame").addEventListener("click",()=>{this.hideWelcomeModal(),this.showGameSetupModal()})}async makeMove(t,e,o,i,r,s=null){this.game.movePiece(t,e,o,i,s);const n=this.transformBoardToScreenCoords(o,i);this.lastMovedPiece={file:n.screenFile,rank:n.screenRank},await this.playMoveSound(r),this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates(),this.checkForAIMove()}async handleCellClick(t,e){const{boardFile:o,boardRank:i}=this.transformScreenToBoardCoords(t,e),r=this.game.board[i][o];if(this.selectedPiece&&(this.selectedPiece.file!==o||this.selectedPiece.rank!==i)&&this.availableMoves.some(n=>n.file===o&&n.rank===i)){const n=this.selectedPiece.piece;n.type==="pawn"&&(n.color==="white"&&i===9||n.color==="black"&&i===0)?(this.pendingPromotion={fromFile:this.selectedPiece.file,fromRank:this.selectedPiece.rank,toFile:o,toRank:i,player:this.game.currentPlayer},this.showPromotionModal()):await this.makeMove(this.selectedPiece.file,this.selectedPiece.rank,o,i,this.game.currentPlayer),this.selectedPiece=null,this.availableMoves=[];return}r&&r.color===this.game.currentPlayer?this.selectedPiece&&this.selectedPiece.file===o&&this.selectedPiece.rank===i?(this.clearHighlights(),this.selectedPiece=null,this.availableMoves=[]):(this.availableMoves=this.game.getAvailableMoves(o,i),this.renderer.highlightPiece(t,e,"selected-piece"),this.renderer.highlightMoves(this.availableMoves,this.game.whitePosition),this.selectedPiece={file:o,rank:i,piece:r}):(this.clearHighlights(),this.selectedPiece=null,this.availableMoves=[])}transformScreenToBoardCoords(t,e){const o=this.game.whitePosition||"bottom",i=Array(12).fill().map(()=>Array(12).fill(null)),r=t+1,s=10-e;i[s][r]={file:t,rank:e};const a=(360-({bottom:0,left:90,top:180,right:270}[o]||0))%360,c=this.game.rotateGrid(i,a);for(let h=0;h<12;h++)for(let d=0;d<12;d++)if(c[h][d]&&d>=1&&d<=10&&h>=1&&h<=10){const f=10-h;return{boardFile:d-1,boardRank:f}}return{boardFile:t,boardRank:e}}transformBoardToScreenCoords(t,e){const o=this.game.whitePosition||"bottom",i=Array(12).fill().map(()=>Array(12).fill(null)),r=10-e,s=t+1;i[r][s]={file:t,rank:e};const l={bottom:0,left:90,top:180,right:270}[o]||0,a=this.game.rotateGrid(i,l);for(let c=0;c<12;c++)for(let h=0;h<12;h++)if(a[c][h]&&h>=1&&h<=10&&c>=1&&c<=10){const p=h-1,f=10-c;return{screenFile:p,screenRank:f}}return{screenFile:t,screenRank:e}}clearHighlights(){this.renderer.clearHighlights()}updateMoveHistory(){const t=document.getElementById("moveList");t.innerHTML="";const e={};this.game.moveNotation.forEach(o=>{e[o.moveNumber]||(e[o.moveNumber]={}),e[o.moveNumber][o.player]=o.notation}),Object.keys(e).forEach(o=>{const i=e[o],r=document.createElement("div");r.className="move-item";const s=document.createElement("span");s.className="move-number",s.textContent=o+".";const n=document.createElement("span");n.className="move-notation white",n.textContent=i.white||"";const l=document.createElement("span");l.className="move-notation black",l.textContent=i.black||"",r.appendChild(s),r.appendChild(n),r.appendChild(l),t.appendChild(r)})}updateButtonStates(){const t=document.getElementById("undoMove"),e=document.getElementById("redoMove");t.disabled=this.game.gameHistory.length===0,e.disabled=this.game.redoStack.length===0}updateGameStatus(){const t=document.getElementById("gameStatus");t.textContent=`${this.game.currentPlayer.charAt(0).toUpperCase()+this.game.currentPlayer.slice(1)}'s turn`,this.game.isCheck()&&(t.textContent+=" - CHECK!"),this.game.isCheckmate()?t.textContent=`CHECKMATE! ${this.game.currentPlayer==="white"?"Black":"White"} wins!`:this.game.isStalemate()&&(t.textContent="STALEMATE! It's a draw!")}resignGame(){const t=this.game.currentPlayer==="white"?"Black":"White";alert(`${this.game.currentPlayer.charAt(0).toUpperCase()+this.game.currentPlayer.slice(1)} resigns! ${t} wins!`),this.game.reset(),this.renderer.renderBoard(this.game),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates()}toggleAudio(){this.audioEnabled=!this.audioEnabled;const e=document.getElementById("toggleAudio").querySelector("i"),o=v();this.audioEnabled?e.className=`${o} fa-volume-up`:e.className=`${o} fa-volume-mute`,console.log(`Audio ${this.audioEnabled?"enabled":"disabled"}`)}async playMoveSound(t){if(!this.audioEnabled)return;const e=new(window.AudioContext||window.webkitAudioContext);e.state==="suspended"&&await e.resume();const o=e.createOscillator(),i=e.createGain();o.connect(i),i.connect(e.destination),t==="white"?(o.frequency.setValueAtTime(1e3,e.currentTime),o.frequency.exponentialRampToValueAtTime(500,e.currentTime+.1)):(o.frequency.setValueAtTime(600,e.currentTime),o.frequency.exponentialRampToValueAtTime(300,e.currentTime+.1)),i.gain.setValueAtTime(.3,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),o.start(e.currentTime),o.stop(e.currentTime+.1)}showGameSetupModal(){const t=document.getElementById("gameSetupModal");t.style.display="flex"}hideGameSetupModal(){const t=document.getElementById("gameSetupModal");t.style.display="none"}showWelcomeModal(){const t=document.getElementById("welcomeModal");t.style.display="flex"}hideWelcomeModal(){const t=document.getElementById("welcomeModal");t.style.display="none"}showPromotionModal(){const t=document.getElementById("promotionModal"),e=t.querySelector('[data-piece="heir"]'),{toFile:o,toRank:i}=this.pendingPromotion,r=this.game.isAdjacentToAnyKing(o,i);e.style.display=r?"none":"flex",t.style.display="flex"}hidePromotionModal(){const t=document.getElementById("promotionModal");t.style.display="none"}async completePromotion(t){if(!this.pendingPromotion)return;const{fromFile:e,fromRank:o,toFile:i,toRank:r,player:s}=this.pendingPromotion;await this.makeMove(e,o,i,r,s,t),this.hidePromotionModal(),this.pendingPromotion=null}startNewGame(){const t=document.getElementById("boardOrientation").value,e=document.getElementById("gameMode").value,o=parseInt(document.getElementById("aiDifficulty").value);this.game.reset(),this.game.whitePosition=t.replace("white-","");const[i,r]=e.split("-");this.game.bottomPlayerType=i,this.game.topPlayerType=r,this.game.aiTimeLimit=o,this.game.currentPlayer="white",this.lastMovedPiece=null,this.renderer.lastMovedPiece=null,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates(),this.hideGameSetupModal(),console.log(`Starting new game: ${e} with ${t}`),console.log(`White position: ${this.game.whitePosition}`),console.log(`Bottom: ${i}, Top: ${r}`),this.checkForAIMove()}showAIThinking(t){const e=t==="white"?"whiteSpinner":"blackSpinner",o=document.getElementById(e);o.classList.add("active");const i=o.querySelector("i")||o.querySelector("svg");i&&i.classList.add("fa-spin")}hideAIThinking(t){const e=t==="white"?"whiteSpinner":"blackSpinner",o=document.getElementById(e);o.classList.remove("active");const i=o.querySelector("i")||o.querySelector("svg");i&&i.classList.remove("fa-spin")}checkForAIMove(){if(this.game.isCheckmate()||this.game.isStalemate()){console.log("Game is over, no AI move");return}const t=this.game.currentPlayer;let e;this.game.whitePosition==="bottom"||this.game.whitePosition==="right"?e=t==="white"?this.game.bottomPlayerType:this.game.topPlayerType:e=t==="white"?this.game.topPlayerType:this.game.bottomPlayerType,console.log(`Check AI move: currentPlayer=${t}, playerType=${e}, whitePosition=${this.game.whitePosition}, bottomPlayer=${this.game.bottomPlayerType}, topPlayer=${this.game.topPlayerType}`),e==="ai"&&(this.showAIThinking(t),setTimeout(()=>{this.makeSimpleAIMove()},500))}async makeSimpleAIMove(){const t=this.game.currentPlayer;this.game.getAIMove(async e=>{if(this.hideAIThinking(t),this.game.movePiece(e.fromFile,e.fromRank,e.toFile,e.toRank,"queen")){const i=this.transformBoardToScreenCoords(e.toFile,e.toRank);this.lastMovedPiece={file:i.screenFile,rank:i.screenRank},await this.playMoveSound(t),this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates(),this.checkForAIMove()}else console.error("AI move failed:",e),await this.fallbackRandomMove()})}async fallbackRandomMove(){const t=[];for(let e=0;e<10;e++)for(let o=0;o<10;o++){const i=this.game.board[e][o];i&&i.color===this.game.currentPlayer&&this.game.getAvailableMoves(o,e).forEach(s=>{t.push({from:{file:o,rank:e},to:{file:s.file,rank:s.rank},piece:i})})}if(t.length>0){const e=t[Math.floor(Math.random()*t.length)],o=this.game.currentPlayer;if(this.game.movePiece(e.from.file,e.from.rank,e.to.file,e.to.rank,"queen")){const r=this.transformBoardToScreenCoords(e.to.file,e.to.rank);this.lastMovedPiece={file:r.screenFile,rank:r.screenRank},await this.playMoveSound(o),this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates(),this.checkForAIMove()}}}rotateOrientation(t){const e=["bottom","left","top","right"],o=e.indexOf(this.game.whitePosition);let i;t==="left"?i=(o+1)%e.length:i=(o-1+e.length)%e.length,this.game.whitePosition=e[i],this.renderer.renderBoard(this.game),console.log(`Orientation changed to: ${this.game.whitePosition}`)}updateStaticIcons(){const t=v().split(" ").filter(o=>o),e=t.join(" ");console.log("Updating static icons with prefix:",e),document.querySelectorAll("i[data-icon]").forEach(o=>{const i=o.dataset.icon,r=C(i);o.classList.remove("fa-solid","fa-duotone","fa-sharp","fa-sharp-duotone","fa-regular","fa-light","fa-thin"),t.forEach(s=>o.classList.add(s)),Array.from(o.classList).forEach(n=>{n.startsWith("fa-")&&!n.match(/^fa-(solid|duotone|sharp|sharp-duotone|regular|light|thin)$/)&&o.classList.remove(n)}),o.classList.add(r)})}initializeTooltips(){const{computePosition:t,flip:e,shift:o,offset:i,arrow:r,autoUpdate:s}=FloatingUIDOM;document.querySelectorAll("[title]").forEach(l=>{const a=document.createElement("div");a.className="tooltip",a.textContent=l.title,l.title="",document.body.appendChild(a);const c=document.createElement("div");c.className="tooltip-arrow",a.appendChild(c);let h;function d(){t(l,a,{placement:"top",middleware:[i(8),e(),o({padding:5})]}).then(({x:b,y,placement:u})=>{Object.assign(a.style,{left:`${b}px`,top:`${y}px`})})}function p(){a.style.display="block",d(),h=s(l,a,d)}function f(){a.style.display="none",h==null||h()}l.addEventListener("mouseenter",p),l.addEventListener("mouseleave",f)})}}document.addEventListener("DOMContentLoaded",()=>{new I,"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(m=>{console.log("ServiceWorker registration successful:",m.scope)}).catch(m=>{console.log("ServiceWorker registration failed:",m)})})});

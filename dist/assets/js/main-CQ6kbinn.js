(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class E{constructor(){this.worker=null,this.isReady=!1,this.onReadyCallback=null,this.moveCallback=null,this.thinking=!1,this.requestId=0,this.pendingRequests={},this.fallbackMode=!1,this.init()}init(){try{if(!window.Worker){console.warn("Web Workers not supported, falling back to main thread"),this.fallbackMode=!0;return}const t=Date.now();this.worker=new Worker(`/js/stockfish/metric-stockfish-worker.js?v=${t}`,{name:"metric-stockfish-worker"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e)},this.worker.onerror=e=>{console.error("Worker error:",e),this.handleWorkerError(e)},this.sendMessage({type:"init"})}catch(t){console.error("Failed to initialize worker:",t),this.fallbackMode=!0}}handleWorkerMessage(t){const e=t.data;if(!e||!e.type){console.error("Invalid worker message:",e);return}switch(console.log("Main thread received:",e.type,e),e.type){case"ready":this.handleReadyMessage(e);break;case"bestmove":this.handleBestMoveMessage(e);break;case"info":this.handleInfoMessage(e);break;case"error":this.handleErrorMessage(e);break;default:console.warn("Unknown worker message type:",e.type)}}handleReadyMessage(t){this.isReady=!0,console.log("Worker ready:",t.data),this.onReadyCallback&&this.onReadyCallback()}handleBestMoveMessage(t){if(this.thinking=!1,t.data&&t.data.bestmove){const e=t.data.bestmove;if(console.log("Worker best move:",e),this.moveCallback){const o=this.parseUCIMove(e);this.moveCallback(o)}}else console.warn("No valid best move from worker"),this.fallbackToMainThread()}handleInfoMessage(t){console.log("Worker info:",t.data)}handleErrorMessage(t){if(console.error("Worker error:",t.data),this.thinking=!1,this.moveCallback){const e=this.moveCallback;this.moveCallback=null,e({fromFile:NaN,fromRank:NaN,toFile:NaN,toRank:NaN})}}handleWorkerError(t){if(console.error("Worker fatal error:",t),this.thinking=!1,this.moveCallback){const e=this.moveCallback;this.moveCallback=null,e({fromFile:NaN,fromRank:NaN,toFile:NaN,toRank:NaN})}t.message&&t.message.includes("Module is not a function")&&(console.error("WASM load failed, terminating worker"),this.fallbackMode=!0,this.worker&&(this.worker.terminate(),this.worker=null))}fallbackToMainThread(){console.warn("Falling back to main thread implementation"),this.fallbackMode=!0,this.moveCallback&&console.error("Main thread fallback not yet implemented")}sendMessage(t,e){if(!this.worker){console.error("Worker not available");return}this.requestId++;const o={...t,id:this.requestId.toString()};e&&(this.pendingRequests[o.id]=e),console.log("Sending to worker:",o.type,o),this.worker.postMessage(o)}onReady(t){this.onReadyCallback=t,this.isReady&&t()}setPosition(t){if(this.fallbackMode){console.warn("Worker fallback mode - setPosition not implemented");return}if(!this.isReady){console.warn("Worker not ready for setPosition");return}this.sendMessage({type:"setPosition",data:{fen:t}})}getLegalMoves(){return console.warn("getLegalMoves not implemented in worker mode"),[]}makeMove(t){return console.warn("makeMove not implemented in worker mode"),!1}getFen(){return console.warn("getFen not implemented in worker mode"),null}isGameOver(){return console.warn("isGameOver not implemented in worker mode"),!1}getResult(){return console.warn("getResult not implemented in worker mode"),"*"}go(t=3e3,e){if(this.fallbackMode){console.warn("Worker fallback mode - using main thread");return}if(!this.isReady){console.warn("Worker not ready for go command");return}if(this.thinking){console.warn("Worker already thinking");return}this.thinking=!0,this.moveCallback=e,this.sendMessage({type:"go",data:{timeLimit:t}})}stop(){this.worker&&this.thinking&&(this.sendMessage({type:"stop"}),this.thinking=!1)}quit(){this.worker&&(this.sendMessage({type:"quit"}),this.worker.terminate(),this.worker=null),this.isReady=!1}parseUCIMove(t){if(!t||t.length<4)return console.error("Invalid UCI move format (too short):",t),{fromFile:NaN,fromRank:NaN,toFile:NaN,toRank:NaN};const e=t.match(/^([a-j])(\d{1,2})([a-j])(\d{1,2})([qrbnck])?$/);if(!e)return console.error("Invalid UCI move format:",t),{fromFile:NaN,fromRank:NaN,toFile:NaN,toRank:NaN};const o=e[1].charCodeAt(0)-97,i=parseInt(e[2])-1,r=e[3].charCodeAt(0)-97,s=parseInt(e[4])-1,n=e[5]||null;return i<0||i>9||s<0||s>9?(console.error("Invalid rank in UCI move:",t,{fromRank:i,toRank:s}),{fromFile:NaN,fromRank:NaN,toFile:NaN,toRank:NaN}):(console.log("Parsed UCI move:",{fromFile:o,fromRank:i,toFile:r,toRank:s,promotion:n}),{fromFile:o,fromRank:i,toFile:r,toRank:s,promotion:n})}}class T{constructor(){this.ffish=null,this.board=null,this.isReady=!1,this.workerReady=!1,this.ffishReady=!1,this.onReadyCallback=null,this.moveCallback=null,this.thinking=!1,this.worker=null,this.useWorker=!0,this.init()}async init(){try{const t=[];this.useWorker&&window.Worker&&(console.log("Initializing Fairy-Stockfish NNUE Worker for search"),this.worker=new E,t.push(new Promise(e=>{this.worker.onReady(()=>{this.workerReady=!0,console.log("Fairy-Stockfish NNUE worker initialized successfully"),e()}),setTimeout(()=>{this.workerReady||(console.warn("Worker initialization timeout, will use fallback"),this.useWorker=!1,e())},1e4)}))),t.push(this.initFfish()),await Promise.all(t),this.ffishReady&&(this.isReady=!0,console.log("StockfishEngine ready:",{workerReady:this.workerReady,ffishReady:this.ffishReady,useWorker:this.useWorker&&this.workerReady}),this.onReadyCallback&&this.onReadyCallback())}catch(t){console.error("Failed to initialize Fairy-Stockfish:",t)}}async initFfish(){try{let t=0;for(;(!window.Module||!window.Module.Board)&&t<200;)await new Promise(e=>setTimeout(e,50)),t++;if(!window.Module||!window.Module.Board){console.warn("ffish Module not loaded, fallback search will be limited");return}this.ffish=window.Module,console.log("ffish.js info:",this.ffish.info()),this.loadMetricChessVariant(),this.ffishReady=!0,console.log("ffish.js initialized for board manipulation")}catch(t){console.error("Failed to initialize ffish.js:",t)}}loadMetricChessVariant(){const t=`
# Metric Chess - 10x10 variant with trebuchets
# Trebuchet: jumps exactly Chebyshev distance 3

[metricchess:chess]
maxRank = 10
maxFile = 10
startFen = trnbqkbnrt/pppppppppp/10/10/10/10/10/10/PPPPPPPPPP/TRNBQKBNRT w KQkq - 0 1
pieceToCharTable = PNBRQ..............Kpnbrq..............k.......T.......t
pocketSize = 0
promotionRank = 10
promotionPieceTypes = qrbnkt
doubleStep = true
doubleStepRank = 2
doubleStepRankMin = 2
castling = true
castlingKingsideFile = h
castlingQueensideFile = c
# Trebuchet: leaper that moves exactly distance 3 (Chebyshev metric)
# All squares where max(|dx|, |dy|) = 3
# Coordinates: (3,0), (0,3), (3,1), (1,3), (3,2), (2,3), (3,3) and their reflections
customPiece1 = t:m(3,0)m(0,3)m(3,1)m(1,3)m(3,2)m(2,3)m(3,3)
`;try{this.ffish.loadVariantConfig(t),console.log("Metric Chess variant configuration loaded successfully")}catch(e){console.error("Failed to load Metric Chess variant:",e)}}onReady(t){this.onReadyCallback=t,this.isReady&&t()}setPosition(t){if(this.ffishReady&&this.ffish)try{this.board&&this.board.delete(),this.board=new this.ffish.Board("metricchess",t||void 0),console.log("Position set:",this.board.fen())}catch(e){console.error("Error setting ffish.js position:",e)}this.useWorker&&this.workerReady&&this.worker&&this.worker.setPosition(t)}getLegalMoves(){if(this.board){const t=this.board.legalMoves();return t?t.split(" ").filter(e=>e.length>0):[]}return[]}makeMove(t){return this.board?this.board.push(t):!1}getFen(){return this.board?this.board.fen():null}isGameOver(){return this.board?this.board.isGameOver():!1}getResult(){return this.board?this.board.result():"*"}async go(t=3e3,e){if(this.thinking){console.log("Cannot make AI move: already thinking");return}if(this.thinking=!0,this.moveCallback=e,console.log("AI go() called:",{useWorker:this.useWorker,workerReady:this.workerReady,ffishReady:this.ffishReady,hasBoard:!!this.board,timeLimit:t}),this.useWorker&&this.workerReady&&this.worker){console.log("Using worker-based Fairy-Stockfish NNUE search");const o=setTimeout(()=>{console.warn("Worker search timeout, falling back to minimax"),this.thinking=!1,this.fallbackSearch(t,e)},t+5e3);this.worker.go(t,i=>{if(clearTimeout(o),this.thinking=!1,console.log("Worker returned move:",i),i&&!isNaN(i.fromFile)&&!isNaN(i.toFile))if(this.board){const r=this.moveToUCI(i),s=this.getLegalMoves();s.includes(r)?(console.log("Worker move validated:",r),e(i)):(console.warn("Worker move not in legal moves:",r,"Legal:",s),this.fallbackSearch(t,e))}else e(i);else console.warn("Invalid move from worker, falling back to minimax"),this.fallbackSearch(t,e)})}else this.ffishReady&&this.board?(console.log("Using minimax search with ffish.js board"),this.fallbackSearch(t,e)):(console.error("Cannot make AI move: no search method available",{useWorker:this.useWorker,workerReady:this.workerReady,ffishReady:this.ffishReady,hasBoard:!!this.board}),this.thinking=!1)}moveToUCI(t){const e="abcdefghij",o=e[t.fromFile],i=e[t.toFile],r=t.fromRank+1,s=t.toRank+1;let n=`${o}${r}${i}${s}`;return t.promotion&&(n+=t.promotion),n}fallbackSearch(t,e){setTimeout(()=>{try{const o=this.findBestMoveIterativeDeepening(t);this.thinking=!1,console.log("AI selected move (fallback):",o),o&&this.moveCallback&&this.moveCallback(o)}catch(o){console.error("Error in fallback search:",o),this.thinking=!1}},100)}findBestMoveIterativeDeepening(t){const e=this.getLegalMoves();if(console.log("Legal moves from ffish:",e),e.length===0)return console.warn("No legal moves available"),null;const o=this.prioritizeMoves(e),i=Date.now();let r=null,s=-1/0,n=1;for(;Date.now()-i<t;){let l=null,a=-1/0;for(const c of o){if(Date.now()-i>=t)break;this.board.push(c);const h=this.minimax(n-1,-1/0,1/0,!1);this.board.pop(),h>a&&(a=h,l=c)}if(l&&Date.now()-i<t)r=l,s=a,console.log(`Depth ${n} completed, best move: ${r}, score: ${s}`);else break;n++}return console.log(`Time-based search completed at depth ${n-1}, selected move: ${r}, score: ${s}`),r}prioritizeMoves(t){return t.sort((e,o)=>{const i=this.scoreMove(e);return this.scoreMove(o)-i})}scoreMove(t){let e=0;if(this.board.isCapture(t)){e+=20;const u=this.board.fen().split(" ")[0].split("/"),k=parseInt(t[1])-1,y=u[9-k];let m=0,v=null;for(const w of y)if(w>="1"&&w<="9")m+=parseInt(w);else{if(m===t.charCodeAt(0)-97){v=w;break}m++}v&&v.toLowerCase()==="t"&&(e+=15)}this.board.push(t),this.board.isCheck()&&(e+=15),this.board.pop();const o=t.charCodeAt(2)-97;o>=3&&o<=6&&(e+=3);const i=parseInt(t[3])-1;i>=6?e+=2:i>=4&&(e+=1);const n=this.board.fen().split(" ")[0].split("/"),l=parseInt(t[1])-1,a=n[9-l];let c=0,h=null;for(const d of a)if(d>="1"&&d<="9")c+=parseInt(d);else{if(c===t.charCodeAt(0)-97){h=d;break}c++}return h&&h.toLowerCase()==="t"&&(e+=5),h&&h.toLowerCase()==="q"&&(e+=2),e}minimax(t,e,o,i){if(t===0||this.board.isGameOver())return this.evaluatePosition();const r=this.getLegalMoves();if(i){let s=-1/0;for(const n of r){this.board.push(n);const l=this.minimax(t-1,e,o,!1);if(this.board.pop(),s=Math.max(s,l),e=Math.max(e,l),o<=e)break}return s}else{let s=1/0;for(const n of r){this.board.push(n);const l=this.minimax(t-1,e,o,!0);if(this.board.pop(),s=Math.min(s,l),o=Math.min(o,l),o<=e)break}return s}}evaluatePosition(){const e=this.board.fen().split(" ")[0],o={p:-1,n:-3,b:-3,r:-5,q:-9,t:-10,k:0,P:1,N:3,B:3,R:5,Q:9,T:10,K:0};let i=0,r=0,s=0,n=0,l=0,a=0,c=0;const h=e.split("/");for(let u=0;u<10;u++){const k=h[u];let y=0;for(const m of k)m>="1"&&m<="9"?y+=parseInt(m):(o[m]!==void 0&&(i+=o[m],m==="T"&&r++,m==="t"&&s++,y>=3&&y<=6&&(m===m.toUpperCase()&&m!=="K"?(a+=.3,n+=.2):m===m.toLowerCase()&&m!=="k"&&(c-=.3,l-=.2)),m===m.toUpperCase()&&m!=="K"?u>=6?n+=.5:u>=4&&(n+=.2):m===m.toLowerCase()&&m!=="k"&&(u<=3?l-=.5:u<=5&&(l-=.2)),["Q","R","B","N","T"].includes(m.toUpperCase())&&u>=2&&u<=7&&y>=2&&y<=7&&(m===m.toUpperCase()?n+=.3:l-=.3)),y++)}r>=2&&(i+=5),s>=2&&(i-=5),r===1&&(i+=2),s===1&&(i-=2),i+=n-l,i+=(a-c)*2;const d=this.isKingExposed(!0),f=this.isKingExposed(!1);return d&&(i-=1),f&&(i+=1),i+=(n-l)*.5,i+=Math.random()*.05-.025,i}isKingExposed(t){const o=this.board.fen().split(" ")[0];return t?o.includes("K")&&["d","e","f"].some(i=>o.includes(`K${i}`)||o.includes(`${i}K`)):o.includes("k")&&["d","e","f"].some(i=>o.includes(`k${i}`)||o.includes(`${i}k`))}stop(){this.useWorker&&this.worker&&this.worker.stop(),this.thinking=!1}quit(){this.useWorker&&this.worker?this.worker.quit():this.board&&(this.board.delete(),this.board=null)}}const I={king:"fa-chess-king",heir:"fa-chess-king",queen:"fa-chess-queen",rook:"fa-chess-rook",bishop:"fa-chess-bishop",knight:"fa-chess-knight",pawn:"fa-chess-pawn",trebuchet:"fa-meteor"},A={king:[{dx:-1,dy:-1},{dx:-1,dy:0},{dx:-1,dy:1},{dx:0,dy:-1},{dx:0,dy:1},{dx:1,dy:-1},{dx:1,dy:0},{dx:1,dy:1}],heir:[{dx:-1,dy:-1},{dx:-1,dy:0},{dx:-1,dy:1},{dx:0,dy:-1},{dx:0,dy:1},{dx:1,dy:-1},{dx:1,dy:0},{dx:1,dy:1}],queen:[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],rook:[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}],bishop:[{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],knight:[{dx:-2,dy:-1},{dx:-2,dy:1},{dx:-1,dy:-2},{dx:-1,dy:2},{dx:1,dy:-2},{dx:1,dy:2},{dx:2,dy:-1},{dx:2,dy:1}],pawn:{white:[{dx:0,dy:1},{dx:0,dy:2}],black:[{dx:0,dy:-1},{dx:0,dy:-2}]}};class P{constructor(){this.board=Array(10).fill().map(()=>Array(10).fill(null)),this.currentPlayer="white",this.gameHistory=[],this.redoStack=[],this.capturedPieces={white:[],black:[]},this.moveCount=0,this.moveNotation=[],this.bottomPlayerType="human",this.topPlayerType="human",this.whitePosition="bottom",this.aiTimeLimit=3e3,this.aiEngine=new T,this.reset()}reset(){this.board=Array(10).fill().map(()=>Array(10).fill(null)),this.currentPlayer="white",this.gameHistory=[],this.redoStack=[],this.capturedPieces={white:[],black:[]},this.moveCount=0,this.moveNotation=[],this.board[0][0]={type:"trebuchet",color:"white"},this.board[0][1]={type:"rook",color:"white"},this.board[0][2]={type:"knight",color:"white"},this.board[0][3]={type:"bishop",color:"white"},this.board[0][4]={type:"queen",color:"white"},this.board[0][5]={type:"king",color:"white"},this.board[0][6]={type:"bishop",color:"white"},this.board[0][7]={type:"knight",color:"white"},this.board[0][8]={type:"rook",color:"white"},this.board[0][9]={type:"trebuchet",color:"white"};for(let t=0;t<10;t++)this.board[1][t]={type:"pawn",color:"white"};this.board[9][0]={type:"trebuchet",color:"black"},this.board[9][1]={type:"rook",color:"black"},this.board[9][2]={type:"knight",color:"black"},this.board[9][3]={type:"bishop",color:"black"},this.board[9][4]={type:"queen",color:"black"},this.board[9][5]={type:"king",color:"black"},this.board[9][6]={type:"bishop",color:"black"},this.board[9][7]={type:"knight",color:"black"},this.board[9][8]={type:"rook",color:"black"},this.board[9][9]={type:"trebuchet",color:"black"};for(let t=0;t<10;t++)this.board[8][t]={type:"pawn",color:"black"};this.initialBoard=this.board.map(t=>[...t])}getPseudoLegalMoves(t,e){const o=this.board[e][t];if(!o)return[];const i=[];if(o.type==="trebuchet")i.push(...this.getTrebuchetMoves(t,e));else if(o.type==="pawn")i.push(...this.getPawnMoves(t,e));else{const r=A[o.type];for(const s of r){let n=s.dx,l=s.dy,a=t+n,c=e+l;if(a<0||a>=10||c<0||c>=10)continue;const h=this.board[c][a];if(["queen","rook","bishop"].includes(o.type)){let d=this.getSlidingMoves(t,e,n,l);i.push(...d)}else if(!h||h.color!==o.color){let d={file:a,rank:c,capture:!!h};(o.type==="king"||o.type==="heir")&&this.isAdjacentToAnyKing(a,c)||i.push(d)}}}return i}getAvailableMoves(t,e){const o=this.getPseudoLegalMoves(t,e);return this.countKings(this.currentPlayer)>1?o:o.filter(r=>{const s=this.board.map(a=>[...a]),n=this.currentPlayer;this.board[r.rank][r.file]=this.board[e][t],this.board[e][t]=null;const l=this.isCheck();return this.board=s,this.currentPlayer=n,!l})}getSlidingMoves(t,e,o,i){const r=[],s=this.board[e][t];for(let n=1;n<10;n++){const l=t+o*n,a=e+i*n;if(l<0||l>=10||a<0||a>=10)break;const c=this.board[a][l];if(!c)r.push({file:l,rank:a,capture:!1});else{c.color!==s.color&&r.push({file:l,rank:a,capture:!0});break}}return r}getTrebuchetMoves(t,e){const o=[],i=this.board[e][t];for(let r=0;r<10;r++)for(let s=0;s<10;s++){const n=Math.abs(r-t),l=Math.abs(s-e);if(Math.max(n,l)===3&&!(n===0&&l===0)){const c=this.board[s][r];(!c||c.color!==i.color)&&o.push({file:r,rank:s,capture:!!c})}}return o}getPawnMoves(t,e){const o=[],i=this.board[e][t],r=i.color==="white"?1:-1,s=e+r;if(s>=0&&s<10&&!this.board[s][t]){o.push({file:t,rank:s,capture:!1});const l=e+r*2;l>=0&&l<10&&!this.board[l][t]&&o.push({file:t,rank:l,capture:!1})}const n=[t-1,t+1];for(const l of n)if(l>=0&&l<10){const a=e+r;if(a>=0&&a<10){const c=this.board[a][l];c&&c.color!==i.color&&o.push({file:l,rank:a,capture:!0})}}return o}movePiece(t,e,o,i,r=null){const s=this.board[e][t];if(!s||!this.getAvailableMoves(t,e).some(h=>h.file===o&&h.rank===i))return!1;const a=this.generateMoveNotation(s,t,e,o,i);this.board[i][o]=s,this.board[e][t]=null,s.type==="pawn"&&(s.color==="white"&&i===9||s.color==="black"&&i===0)&&(r?s.type=r:s.type="queen");const c=this.board[i][o];return c&&c.color!==s.color&&this.capturedPieces[s.color].push(c),this.moveNotation.push({moveNumber:Math.floor(this.moveCount/2)+1,player:this.currentPlayer,notation:a}),this.gameHistory.push({board:this.board.map(h=>[...h]),currentPlayer:this.currentPlayer,moveCount:this.moveCount,capturedPieces:{...this.capturedPieces},notation:[...this.moveNotation],fromFile:t,fromRank:e,toFile:o,toRank:i}),this.redoStack=[],this.currentPlayer=this.currentPlayer==="white"?"black":"white",this.moveCount++,!0}undoMove(){if(this.gameHistory.length===0)return!1;const t=this.gameHistory.pop();if(this.redoStack.push(t),this.gameHistory.length>0){const e=this.gameHistory[this.gameHistory.length-1];this.board=e.board.map(o=>[...o]),this.currentPlayer=e.currentPlayer,this.moveCount=e.moveCount,this.capturedPieces={...e.capturedPieces},this.moveNotation=[...e.notation]}else this.board=this.initialBoard.map(e=>[...e]),this.currentPlayer="white",this.moveCount=0,this.capturedPieces={white:[],black:[]},this.moveNotation=[];return!0}redoMove(){if(this.redoStack.length===0)return!1;const t=this.redoStack.pop();return this.board=t.board.map(e=>[...e]),this.currentPlayer=t.currentPlayer,this.moveCount=t.moveCount,this.capturedPieces={...t.capturedPieces},this.moveNotation=[...t.notation],this.gameHistory.push(t),this.currentPlayer=this.currentPlayer==="white"?"black":"white",this.moveCount++,!0}generateMoveNotation(t,e,o,i,r){const s=t.type.charAt(0).toUpperCase(),n=`${e}${o}`,l=`${i}${r}`,a=this.board[r][i];return a&&a.color!==t.color?`${s}${n}x${l}`:`${s}${n}-${l}`}isCheck(){if(this.countKings(this.currentPlayer)!==1)return!1;let e,o;for(let i=0;i<10;i++)for(let r=0;r<10;r++){const s=this.board[i][r];if(s&&(s.type==="king"||s.type==="heir")&&s.color===this.currentPlayer){e=r,o=i;break}}if(e===void 0||o===void 0)return!1;for(let i=0;i<10;i++)for(let r=0;r<10;r++){const s=this.board[i][r];if(s&&s.color!==this.currentPlayer&&this.getPseudoLegalMoves(r,i).some(a=>a.file===e&&a.rank===o))return!0}return!1}isCheckmate(){if(!this.isCheck())return!1;for(let t=0;t<10;t++)for(let e=0;e<10;e++){const o=this.board[t][e];if(o&&o.color===this.currentPlayer&&this.getAvailableMoves(e,t).length>0)return!1}return!0}isStalemate(){if(this.isCheck())return!1;for(let t=0;t<10;t++)for(let e=0;e<10;e++){const o=this.board[t][e];if(o&&o.color===this.currentPlayer&&this.getAvailableMoves(e,t).length>0)return!1}return!0}getPieceIcon(t){return t?I[t.type]:null}countKings(t){let e=0;for(let o=0;o<10;o++)for(let i=0;i<10;i++){const r=this.board[o][i];r&&r.color===t&&(r.type==="king"||r.type==="heir")&&e++}return e}isAdjacentToAnyKing(t,e){for(let o=-1;o<=1;o++)for(let i=-1;i<=1;i++){if(o===0&&i===0)continue;const r=e+o,s=t+i;if(r>=0&&r<10&&s>=0&&s<10){const n=this.board[r][s];if(n&&(n.type==="king"||n.type==="heir"))return!0}}return!1}generateFEN(){let t="";for(let e=9;e>=0;e--){let o=0;for(let i=0;i<10;i++){const r=this.board[e][i];if(r){o>0&&(t+=o,o=0);let s=r.type.charAt(0).toUpperCase();r.type==="knight"&&(s="N"),r.type==="trebuchet"&&(s="T"),r.type==="heir"&&(s="H"),t+=r.color==="white"?s:s.toLowerCase()}else o++}o>0&&(t+=o),e>0&&(t+="/")}return t+=` ${this.currentPlayer.charAt(0)}`,t+=" -",t+=" -",t+=` 0 ${Math.floor(this.moveCount/2)+1}`,t}getAIMove(t){const e=this.generateFEN();console.log("Setting FEN for AI:",e),this.aiEngine.setPosition(e),this.aiEngine.go(this.aiTimeLimit,o=>{if(console.log("Raw move from AI engine:",o),typeof o=="object"&&o.fromFile!==void 0)console.log("Move already parsed:",o),t(o);else if(typeof o=="string"){const i=o.match(/^([a-j])(\d+)([a-j])(\d+)/);if(!i){console.error("Invalid UCI move format:",o),t({fromFile:NaN,fromRank:NaN,toFile:NaN,toRank:NaN});return}const r=i[1].charCodeAt(0)-97,s=parseInt(i[2])-1,n=i[3].charCodeAt(0)-97,l=parseInt(i[4])-1;console.log("Parsed move:",{fromFile:r,fromRank:s,toFile:n,toRank:l}),t({fromFile:r,fromRank:s,toFile:n,toRank:l})}else console.error("Unexpected move format:",o),t({fromFile:NaN,fromRank:NaN,toFile:NaN,toRank:NaN})})}displayBoardCompact(){console.log("Compact Text Board (0-9 at bottom and left):");for(let t=9;t>=0;t--){let e=t+" ";for(let o=0;o<10;o++){const i=this.board[t][o];if(i){let r;i.type==="knight"?r="n":r=i.type.charAt(0),e+=(i.color==="white"?r.toLowerCase():r.toUpperCase())+" "}else e+=". "}console.log(e)}console.log("  0 1 2 3 4 5 6 7 8 9"),console.log(`
Piece Legend:`),console.log("Lowercase = White pieces: t=trebuchet, r=rook, n=knight, b=bishop, q=queen, k=king, p=pawn"),console.log("Uppercase = Black pieces: T=trebuchet, R=rook, N=knight, B=bishop, Q=queen, K=king, P=pawn"),console.log(". = Empty square")}rotateGrid(t,e){const o=(e%360+360)%360;if(![0,90,180,270].includes(o))throw new Error("Rotation must be a multiple of 90 degrees (0, 90, 180, 270)");const i=12,r=o/90;let s=t.map(n=>[...n]);for(let n=0;n<r;n++){const l=Array.from({length:i},()=>Array(i).fill(null));for(let a=0;a<i;a++)for(let c=0;c<i;c++)l[a][i-1-c]=s[c][a];s=l}return s}displayBoardWithOrientation(t){console.log(`Compact Text Board (Orientation: ${t}):`);const e=Array(12).fill().map(()=>Array(12).fill(null));for(let s=0;s<10;s++)for(let n=0;n<10;n++){const l=10-s,a=n+1;this.board[s][n]?e[l][a]=this.board[s][n]:(n+s)%2===1?e[l][a]="·":e[l][a]=null}for(let s=0;s<10;s++)e[11][s+1]=String(s);for(let s=0;s<10;s++)e[s+1][0]=String(9-s);e[0][0]="D",e[11][11]="D",e[0][11]="L",e[11][0]="L";const i={bottom:0,left:90,top:180,right:270}[t]||0;console.log(`Rotation: ${i}° clockwise`);const r=this.rotateGrid(e,i);for(let s=0;s<12;s++){let n="";for(let l=0;l<12;l++){const a=r[s][l];if(a===null)n+="  ";else if(typeof a=="string")n+=a+" ";else if(a){let c;a.type==="knight"?c="n":c=a.type.charAt(0),n+=(a.color==="white"?c.toLowerCase():c.toUpperCase())+" "}else a==="·"?n+="· ":n+="  "}console.log(n.trimEnd())}console.log(`
Piece Legend:`),console.log("Lowercase = White pieces: t=trebuchet, r=rook, n=knight, b=bishop, q=queen, k=king, p=pawn"),console.log("Uppercase = Black pieces: T=trebuchet, R=rook, N=knight, B=bishop, Q=queen, K=king, P=pawn"),console.log("· = Empty dark square, D/L = Corner square colors (Dark/Light)")}}let p={kitCode:null,stylePrefix:"fa-solid",icons:{pieces:{king:"fa-chess-king",heir:"fa-chess-king",queen:"fa-chess-queen",rook:"fa-chess-rook",bishop:"fa-chess-bishop",knight:"fa-chess-knight",pawn:"fa-chess-pawn",trebuchet:"fa-meteor"},ui:{whiteSpinner:"fa-atom",blackSpinner:"fa-atom",newGame:"fa-plus-circle",resetGame:"fa-refresh",undoMove:"fa-undo",redoMove:"fa-redo",resignGame:"fa-flag",rotateLeft:"fa-arrow-left",rotateRight:"fa-arrow-right",toggleAudio:"fa-volume-up",chessBoard:"fa-chess-board",trebuchetFeature:"fa-meteor",heirFeature:"fa-crown",aiFeature:"fa-brain",undoFeature:"fa-undo",responsiveFeature:"fa-mobile-alt",customBoard:"fa-screwdriver-wrench",themePalette:"fa-palette"}}};async function S(){var g;try{const t=await fetch("metric-chess.json");if(!t.ok)throw new Error(`HTTP ${t.status}`);const e=await t.json();if(e.fontAwesomeKit&&typeof e.fontAwesomeKit=="string"&&e.fontAwesomeKit.trim()){p.kitCode=e.fontAwesomeKit.trim(),p.stylePrefix=((g=e.fontAwesomeStyle)==null?void 0:g.trim())||"fa-duotone";const o=document.createElement("script");o.src=`https://kit.fontawesome.com/${p.kitCode}.js`,o.crossOrigin="anonymous",o.async=!0,o.onload=()=>console.log("Font Awesome Pro kit loaded:",p.stylePrefix),o.onerror=()=>console.warn("Failed to load Font Awesome kit"),document.head.appendChild(o)}else{console.log("No valid Font Awesome kit found in config — using free icons"),p.stylePrefix="fa-solid";const o=document.createElement("link");o.rel="stylesheet",o.href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css",document.head.appendChild(o)}if(e.fontAwesomeKit&&typeof e.fontAwesomeKit=="string"&&e.fontAwesomeKit.trim()&&e.icons){if(e.icons.pieces){const o={};for(const[i,r]of Object.entries(e.icons.pieces))o[i]=Array.isArray(r)?r:[r];p.icons.pieces={...p.icons.pieces,...o}}if(e.icons.ui){const o={};for(const[i,r]of Object.entries(e.icons.ui))o[i]=Array.isArray(r)?r:[r];p.icons.ui={...p.icons.ui,...o}}}}catch{console.log("No metric-chess.json found or error loading it — using free Font Awesome");const e=document.createElement("link");e.rel="stylesheet",e.href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css",document.head.appendChild(e)}return p}function b(){return p.stylePrefix}function M(g){const t=p.icons.pieces[g]||"fa-question";return Array.isArray(t)?t:[t]}function C(g){const t=p.icons.ui[g]||"fa-question";return Array.isArray(t)?t:[t]}window.getFAIconPrefix=b;window.getPieceIcon=M;window.getUIIcon=C;class x{constructor(){this.boardElement=document.getElementById("chessBoard"),this.chessGame=new P,this.lastMovedPiece=null}initializeBoard(){this.boardElement.innerHTML="";for(let t=9;t>=0;t--)for(let e=0;e<10;e++){const o=document.createElement("div");o.className="cell",o.dataset.coord=`${e}${t}`,(e+t)%2===1?o.classList.add("dark-square"):o.classList.add("light-square"),this.boardElement.appendChild(o)}}updateSquareColors(t="bottom"){const e=Array(12).fill().map(()=>Array(12).fill(null));for(let s=0;s<10;s++)for(let n=0;n<10;n++){const l=10-s,a=n+1;(n+s)%2===1?e[l][a]="·":e[l][a]=null}e[0][0]="D",e[11][11]="D",e[0][11]="L",e[11][0]="L";const i={bottom:0,left:90,top:180,right:270}[t]||0,r=this.chessGame.rotateGrid(e,i);for(let s=0;s<12;s++)for(let n=0;n<12;n++){const l=r[s][n];if(n>=1&&n<=10&&s>=1&&s<=10){const a=n-1,c=10-s,h=this.getCellElement(a,c);if(!h)continue;h.classList.remove("light-square","dark-square"),l==="·"?h.classList.add("dark-square"):l===null&&h.classList.add("light-square")}}}renderBoard(t){document.querySelectorAll(".chess-piece").forEach(a=>a.remove());const o=t.whitePosition||"bottom",i=t.board;this.updateCoordinateLabels(o);const r=Array(12).fill().map(()=>Array(12).fill(null));for(let a=0;a<10;a++)for(let c=0;c<10;c++){const h=10-a,d=c+1;if(i[a][c]){const f=i[a][c];r[h][d]={piece:f,originalFile:c,originalRank:a,type:"piece"}}else(c+a)%2===1?r[h][d]="·":r[h][d]=null}const n={bottom:0,left:90,top:180,right:270}[o]||0,l=this.chessGame.rotateGrid(r,n);for(let a=0;a<12;a++)for(let c=0;c<12;c++){const h=l[a][c];if(c>=1&&c<=10&&a>=1&&a<=10){const d=c-1,f=10-a,u=this.getCellElement(d,f);if(!u)continue;const k=u.querySelector(".chess-piece");if(k&&k.remove(),u.classList.remove("light-square","dark-square"),h==="·")u.classList.add("dark-square");else if(h===null)u.classList.add("light-square");else if(h&&typeof h=="object"&&h.type==="piece"){const y=h.originalFile,m=h.originalRank;(y+m)%2===1?u.classList.add("dark-square"):u.classList.add("light-square"),this.renderPiece(d,f,h.piece)}}}}renderPiece(t,e,o){const i=this.getCellElement(t,e);if(!i)return;const r=i.querySelector(".chess-piece");r&&r.remove();const s=document.createElement("i");s.className=`${b()} ${this.getPieceIcon(o.type)} chess-piece ${o.color}`,s.dataset.piece=o.type,s.dataset.color=o.color,this.lastMovedPiece&&this.lastMovedPiece.file===t&&this.lastMovedPiece.rank===e&&s.classList.add("last-moved"),i.appendChild(s)}getPieceIcon(t){return M(t)}getCellElement(t,e){return document.querySelector(`.cell[data-coord="${t}${e}"]`)}highlightPiece(t,e,o){const i=this.getCellElement(t,e);i&&i.classList.add(o)}highlightMoves(t,e="bottom"){this.clearMoveHighlights();const o=Array(12).fill().map(()=>Array(12).fill(null));t.forEach(n=>{const l=10-n.rank,a=n.file+1;o[l][a]=n});const r={bottom:0,left:90,top:180,right:270}[e]||0,s=this.chessGame.rotateGrid(o,r);for(let n=0;n<12;n++)for(let l=0;l<12;l++){const a=s[n][l];if(a&&typeof a=="object"&&a.file!==void 0&&a.rank!==void 0&&l>=1&&l<=10&&n>=1&&n<=10){const c=l-1,h=10-n,d=this.getCellElement(c,h);if(d){const f=document.createElement("div");f.className=`highlight ${a.capture?"capture-move":"available-move"}`,d.appendChild(f)}}}}clearHighlights(){this.clearSelectionHighlights(),this.clearMoveHighlights()}clearSelectionHighlights(){document.querySelectorAll(".selected-piece").forEach(e=>{e.classList.remove("selected-piece")})}clearMoveHighlights(){document.querySelectorAll(".highlight").forEach(e=>{e.remove()})}updateCoordinateLabels(t="bottom"){const e=Array(12).fill().map(()=>Array(12).fill(null));for(let s=0;s<10;s++)e[11][s+1]=String(s);for(let s=0;s<10;s++)e[s+1][0]=String(9-s);e[0][0]="D",e[11][11]="D",e[0][11]="L",e[11][0]="L";const i={bottom:0,left:90,top:180,right:270}[t]||0,r=this.chessGame.rotateGrid(e,i);this.updateLabelElements(r,t)}updateLabelElements(t,e){document.querySelectorAll(".coordinate-labels").forEach(s=>s.style.display="none");const i={bottom:["bottom","left"],left:["left","top"],top:["top","right"],right:["right","bottom"]}[e]||["bottom","left"],r={bottom:t[11].slice(1,11).map(s=>s||""),left:t.slice(1,11).map(s=>s[0]||""),top:t[0].slice(1,11).map(s=>s||""),right:t.slice(1,11).map(s=>s[11]||"")};i.forEach(s=>{s==="bottom"||s==="top"?this.updateFileLabels(`.file-labels.${s}`,r[s]):this.updateRankLabels(`.rank-labels.${s}`,r[s]),document.querySelector(`.${s==="bottom"||s==="top"?"file":"rank"}-labels.${s}`).style.display="flex"})}updateFileLabels(t,e){const o=document.querySelector(t);if(!o)return;const i=o.querySelectorAll(".file-label");for(let r=0;r<i.length&&r<e.length;r++)i[r].textContent=e[r]}updateRankLabels(t,e){const o=document.querySelector(t);if(!o)return;const i=o.querySelectorAll(".rank-label");for(let r=0;r<i.length&&r<e.length;r++)i[r].textContent=e[r]}}class B{constructor(){this.gameEnded=!1,this.initializeApp()}async initializeApp(){await S(),this.updateStaticIcons(),this.game=new P,this.renderer=new x,this.selectedPiece=null,this.availableMoves=[],this.audioEnabled=!0,this.lastMovedPiece=null,this.customizationMode=!1,this.customizationTarget=null,this.game.bottomPlayerType="human",this.game.topPlayerType="ai",this.game.whitePosition="bottom",this.setupModalEventListeners(),this.initialize(),this.showWelcomeModal()}initialize(){this.renderer.initializeBoard(),this.renderer.renderBoard(this.game),this.setupEventListeners(),this.updateGameStatus(),this.updateButtonStates(),this.checkForAIMove(),this.initializeTooltips()}setupEventListeners(){document.getElementById("chessBoard").addEventListener("click",t=>{const e=t.target.closest(".cell");if(!e)return;const o=e.dataset.coord,i=parseInt(o[0]),r=parseInt(o[1]);this.handleCellClick(i,r)}),document.getElementById("resetGame").addEventListener("click",()=>{this.game.reset(),this.gameEnded=!1,this.lastMovedPiece=null,this.renderer.lastMovedPiece=null,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates()}),document.getElementById("undoMove").addEventListener("click",()=>{const t=this.game.gameHistory[this.game.gameHistory.length-1];if(this.game.undoMove(),this.gameEnded=!1,t){const e=this.transformBoardToScreenCoords(t.fromFile,t.fromRank);this.lastMovedPiece={file:e.screenFile,rank:e.screenRank}}else this.lastMovedPiece=null;this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates()}),document.getElementById("redoMove").addEventListener("click",()=>{const t=this.game.redoStack[this.game.redoStack.length-1];if(this.game.redoMove(),this.gameEnded=!1,t){const e=this.transformBoardToScreenCoords(t.toFile,t.toRank);this.lastMovedPiece={file:e.screenFile,rank:e.screenRank}}else this.lastMovedPiece=null;this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates()}),document.getElementById("newGame").addEventListener("click",()=>{this.showGameSetupModal()}),document.getElementById("rotateLeft").addEventListener("click",()=>{this.rotateOrientation("left")}),document.getElementById("resignGame").addEventListener("click",()=>{this.resignGame()}),document.getElementById("themePalette").addEventListener("click",()=>{this.changeTheme()}),document.getElementById("customBoard").addEventListener("click",()=>{this.toggleCustomizationMode()}),document.getElementById("undoCustom").addEventListener("click",()=>{this.undoCustomization()}),document.getElementById("clearSquare").addEventListener("click",()=>{this.clearSquare()}),document.getElementById("clearRank").addEventListener("click",()=>{this.clearRank()}),document.getElementById("clearFile").addEventListener("click",()=>{this.clearFile()}),document.getElementById("clearBoard").addEventListener("click",()=>{this.clearAll()}),document.getElementById("mirrorBoard").addEventListener("click",()=>{this.mirrorBoard()}),document.getElementById("resetBoard").addEventListener("click",()=>{this.resetBoard()}),document.querySelectorAll(".piece-btn").forEach(t=>{t.addEventListener("click",e=>{const o=e.currentTarget.dataset.piece,i=e.currentTarget.dataset.color;this.placeCustomPiece(this.customizationTarget.file,this.customizationTarget.rank,{type:o,color:i})})}),document.querySelectorAll(".clear-btn").forEach(t=>{t.addEventListener("click",e=>{const o=e.currentTarget.textContent;o.includes("Piece")?this.clearSquare():o.includes("Rank")?this.clearRank(this.customizationTarget.rank):o.includes("File")?this.clearFile(this.customizationTarget.file):o.includes("Board")&&this.clearAll()})}),document.getElementById("toggleAudio").addEventListener("click",()=>{this.toggleAudio()}),document.getElementById("startGame").addEventListener("click",()=>{this.startNewGame()}),document.getElementById("cancelGame").addEventListener("click",()=>{this.hideGameSetupModal()}),document.querySelectorAll(".promotion-piece").forEach(t=>{t.addEventListener("click",e=>{const o=e.currentTarget.dataset.piece;this.completePromotion(o)})})}setupModalEventListeners(){document.getElementById("startWelcomeGame").addEventListener("click",()=>{this.hideWelcomeModal(),this.showGameSetupModal()})}async makeMove(t,e,o,i,r,s=null){this.game.movePiece(t,e,o,i,s);const n=this.transformBoardToScreenCoords(o,i);this.lastMovedPiece={file:n.screenFile,rank:n.screenRank},await this.playMoveSound(r),this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates(),this.checkForAIMove()}async handleCellClick(t,e){if(this.customizationMode){this.handleCustomizationClick(t,e);return}if(this.gameEnded){console.log("Game has ended, ignoring cell click");return}const{boardFile:o,boardRank:i}=this.transformScreenToBoardCoords(t,e),r=this.game.board[i][o];if(this.selectedPiece&&(this.selectedPiece.file!==o||this.selectedPiece.rank!==i)&&this.availableMoves.some(n=>n.file===o&&n.rank===i)){const n=this.selectedPiece.piece;n.type==="pawn"&&(n.color==="white"&&i===9||n.color==="black"&&i===0)?(this.pendingPromotion={fromFile:this.selectedPiece.file,fromRank:this.selectedPiece.rank,toFile:o,toRank:i,player:this.game.currentPlayer},this.showPromotionModal()):await this.makeMove(this.selectedPiece.file,this.selectedPiece.rank,o,i,this.game.currentPlayer),this.selectedPiece=null,this.availableMoves=[];return}r&&r.color===this.game.currentPlayer?this.selectedPiece&&this.selectedPiece.file===o&&this.selectedPiece.rank===i?(this.clearHighlights(),this.selectedPiece=null,this.availableMoves=[]):(this.availableMoves=this.game.getAvailableMoves(o,i),this.renderer.highlightPiece(t,e,"selected-piece"),this.renderer.highlightMoves(this.availableMoves,this.game.whitePosition),this.selectedPiece={file:o,rank:i,piece:r}):(this.clearHighlights(),this.selectedPiece=null,this.availableMoves=[])}transformScreenToBoardCoords(t,e){const o=this.game.whitePosition||"bottom",i=Array(12).fill().map(()=>Array(12).fill(null)),r=t+1,s=10-e;i[s][r]={file:t,rank:e};const a=(360-({bottom:0,left:90,top:180,right:270}[o]||0))%360,c=this.game.rotateGrid(i,a);for(let h=0;h<12;h++)for(let d=0;d<12;d++)if(c[h][d]&&d>=1&&d<=10&&h>=1&&h<=10){const u=10-h;return{boardFile:d-1,boardRank:u}}return{boardFile:t,boardRank:e}}transformBoardToScreenCoords(t,e){const o=this.game.whitePosition||"bottom",i=Array(12).fill().map(()=>Array(12).fill(null)),r=10-e,s=t+1;i[r][s]={file:t,rank:e};const l={bottom:0,left:90,top:180,right:270}[o]||0,a=this.game.rotateGrid(i,l);for(let c=0;c<12;c++)for(let h=0;h<12;h++)if(a[c][h]&&h>=1&&h<=10&&c>=1&&c<=10){const f=h-1,u=10-c;return{screenFile:f,screenRank:u}}return{screenFile:t,screenRank:e}}clearHighlights(){this.renderer.clearHighlights()}updateMoveHistory(){const t=document.getElementById("moveList");t.innerHTML="";const e={};this.game.moveNotation.forEach(o=>{e[o.moveNumber]||(e[o.moveNumber]={}),e[o.moveNumber][o.player]=o.notation}),Object.keys(e).forEach(o=>{const i=e[o],r=document.createElement("div");r.className="move-item";const s=document.createElement("span");s.className="move-number",s.textContent=o+".";const n=document.createElement("span");n.className="move-notation white",n.textContent=i.white||"";const l=document.createElement("span");l.className="move-notation black",l.textContent=i.black||"",r.appendChild(s),r.appendChild(n),r.appendChild(l),t.appendChild(r)})}updateButtonStates(){const t=document.getElementById("undoMove"),e=document.getElementById("redoMove");t.disabled=this.game.gameHistory.length===0,e.disabled=this.game.redoStack.length===0}updateGameStatus(){const t=document.getElementById("gameStatus");if(this.game.isCheckmate())t.textContent=`CHECKMATE! ${this.game.currentPlayer==="white"?"Dark":"Light"} wins!`;else if(this.game.isStalemate())t.textContent="STALEMATE - No winner";else{const e=this.game.currentPlayer==="white"?"Light":"Dark";this.game.currentPlayer,this.game.isCheck()?t.textContent=`${e} is in CHECK!`:this.game.bottomPlayerType==="ai"&&this.game.currentPlayer==="white"||this.game.topPlayerType==="ai"&&this.game.currentPlayer==="black"?t.textContent=`${e} is thinking...`:t.textContent=`Waiting for ${e} to play`}}resignGame(){const t=this.game.currentPlayer==="white"?"Light":"Dark",e=document.getElementById("gameStatus");e.textContent=`${t} has RESIGNED`,this.gameEnded=!0,this.hideAIThinking("white"),this.hideAIThinking("black"),this.game.aiEngine&&typeof this.game.aiEngine.stop=="function"&&this.game.aiEngine.stop(),this.clearHighlights(),this.selectedPiece=null,this.availableMoves=[]}toggleAudio(){this.audioEnabled=!this.audioEnabled;const e=document.getElementById("toggleAudio").querySelector("i"),o=b();this.audioEnabled?e.className=`${o} fa-volume-up`:e.className=`${o} fa-volume-mute`,console.log(`Audio ${this.audioEnabled?"enabled":"disabled"}`)}async playMoveSound(t){if(!this.audioEnabled)return;const e=new(window.AudioContext||window.webkitAudioContext);e.state==="suspended"&&await e.resume();const o=e.createOscillator(),i=e.createGain();o.connect(i),i.connect(e.destination),t==="white"?(o.frequency.setValueAtTime(1e3,e.currentTime),o.frequency.exponentialRampToValueAtTime(500,e.currentTime+.1)):(o.frequency.setValueAtTime(600,e.currentTime),o.frequency.exponentialRampToValueAtTime(300,e.currentTime+.1)),i.gain.setValueAtTime(.3,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),o.start(e.currentTime),o.stop(e.currentTime+.1)}showGameSetupModal(){const t=document.getElementById("gameSetupModal");t.style.display="flex"}hideGameSetupModal(){const t=document.getElementById("gameSetupModal");t.style.display="none"}showWelcomeModal(){const t=document.getElementById("welcomeModal");t.style.display="flex"}hideWelcomeModal(){const t=document.getElementById("welcomeModal");t.style.display="none"}showPromotionModal(){const t=document.getElementById("promotionModal"),e=t.querySelector('[data-piece="heir"]'),{toFile:o,toRank:i}=this.pendingPromotion,r=this.game.isAdjacentToAnyKing(o,i);e.style.display=r?"none":"flex",t.style.display="flex"}hidePromotionModal(){const t=document.getElementById("promotionModal");t.style.display="none"}async completePromotion(t){if(!this.pendingPromotion)return;const{fromFile:e,fromRank:o,toFile:i,toRank:r,player:s}=this.pendingPromotion;await this.makeMove(e,o,i,r,s,t),this.hidePromotionModal(),this.pendingPromotion=null}startNewGame(){const t=document.getElementById("boardOrientation").value,e=document.getElementById("gameMode").value,o=parseInt(document.getElementById("aiDifficulty").value),i=document.getElementById("themeSelector").value;this.game.reset(),this.gameEnded=!1,this.game.whitePosition=t.replace("white-","");const[r,s]=e.split("-");this.game.bottomPlayerType=r,this.game.topPlayerType=s,this.game.aiTimeLimit=o,this.game.currentPlayer="white",this.lastMovedPiece=null,this.renderer.lastMovedPiece=null,this.applyTheme(i),this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates(),this.hideGameSetupModal(),console.log(`Starting new game: ${e} with ${t}`),console.log(`White position: ${this.game.whitePosition}`),console.log(`Bottom: ${r}, Top: ${s}`),console.log(`Theme: ${i}`),this.checkForAIMove()}showAIThinking(t){const e=t==="white"?"whiteSpinner":"blackSpinner",o=document.getElementById(e);o.classList.add("active");const i=o.querySelector("i")||o.querySelector("svg");i&&i.classList.add("fa-spin")}hideAIThinking(t){const e=t==="white"?"whiteSpinner":"blackSpinner",o=document.getElementById(e);o.classList.remove("active");const i=o.querySelector("i")||o.querySelector("svg");i&&i.classList.remove("fa-spin")}checkForAIMove(){if(this.gameEnded){console.log("Game has ended, no AI move");return}if(this.game.isCheckmate()||this.game.isStalemate()){console.log("Game is over, no AI move");return}const t=this.game.currentPlayer;let e;this.game.whitePosition==="bottom"||this.game.whitePosition==="right"?e=t==="white"?this.game.bottomPlayerType:this.game.topPlayerType:e=t==="white"?this.game.topPlayerType:this.game.bottomPlayerType,console.log(`Check AI move: currentPlayer=${t}, playerType=${e}, whitePosition=${this.game.whitePosition}, bottomPlayer=${this.game.bottomPlayerType}, topPlayer=${this.game.topPlayerType}`),e==="ai"&&(this.showAIThinking(t),setTimeout(()=>{this.makeSimpleAIMove()},500))}async makeSimpleAIMove(){if(this.gameEnded){console.log("Game has ended, skipping AI move"),this.hideAIThinking(this.game.currentPlayer);return}const t=this.game.currentPlayer;this.game.getAIMove(async e=>{if(this.hideAIThinking(t),this.gameEnded){console.log("Game ended while AI was thinking, skipping move");return}if(this.game.movePiece(e.fromFile,e.fromRank,e.toFile,e.toRank,"queen")){const i=this.transformBoardToScreenCoords(e.toFile,e.toRank);this.lastMovedPiece={file:i.screenFile,rank:i.screenRank},await this.playMoveSound(t),this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates(),this.checkForAIMove()}else console.error("AI move failed:",e),await this.fallbackRandomMove()})}async fallbackRandomMove(){if(this.gameEnded){console.log("Game has ended, skipping fallback random move");return}const t=[];for(let e=0;e<10;e++)for(let o=0;o<10;o++){const i=this.game.board[e][o];i&&i.color===this.game.currentPlayer&&this.game.getAvailableMoves(o,e).forEach(s=>{t.push({from:{file:o,rank:e},to:{file:s.file,rank:s.rank},piece:i})})}if(t.length>0){const e=t[Math.floor(Math.random()*t.length)],o=this.game.currentPlayer;if(this.game.movePiece(e.from.file,e.from.rank,e.to.file,e.to.rank,"queen")){const r=this.transformBoardToScreenCoords(e.to.file,e.to.rank);this.lastMovedPiece={file:r.screenFile,rank:r.screenRank},await this.playMoveSound(o),this.renderer.lastMovedPiece=this.lastMovedPiece,this.renderer.renderBoard(this.game),this.updateGameStatus(),this.clearHighlights(),this.updateMoveHistory(),this.updateButtonStates(),this.checkForAIMove()}}}rotateOrientation(t){const e=["bottom","left","top","right"],o=e.indexOf(this.game.whitePosition);let i;t==="left"?i=(o+1)%e.length:i=(o-1+e.length)%e.length,this.game.whitePosition=e[i],this.renderer.renderBoard(this.game),console.log(`Orientation changed to: ${this.game.whitePosition}`)}toggleCustomizationMode(){this.customizationMode=!this.customizationMode;const t=document.getElementById("customBoard"),e=t.querySelector("i"),o=b(),i=document.getElementById("customizationModal");this.customizationMode?(e.className=`${o} fa-screwdriver-wrench customization-active`,t.title="Stop customizing board",this.renderer.clearHighlights(),this.selectedPiece=null,this.availableMoves=[],i.style.display="flex",console.log("Customization mode enabled")):(e.className=`${o} fa-screwdriver-wrench`,t.title="Customize board",this.customizationTarget=null,this.renderer.clearHighlights(),i.style.display="none",console.log("Customization mode disabled"))}handleCustomizationClick(t,e){const{boardFile:o,boardRank:i}=this.transformScreenToBoardCoords(t,e);if(!this.customizationTarget)this.customizationTarget={file:o,rank:i},this.renderer.clearHighlights(),this.renderer.highlightPiece(t,e,"customization-target"),document.getElementById("customizationModal").style.display="flex";else{const r=this.game.board[i][o],s=this.game.board[this.customizationTarget.rank][this.customizationTarget.file];this.game.board[this.customizationTarget.rank][this.customizationTarget.file]=r,this.game.board[i][o]=s,this.customizationTarget=null,this.renderer.clearHighlights(),this.renderer.renderBoard(this.game)}}placeCustomPiece(t,e,o){this.game.board[e][t]=o,this.customizationTarget=null,this.renderer.clearHighlights(),this.renderer.renderBoard(this.game),document.getElementById("customizationModal").style.display="none"}clearRank(t){for(let e=0;e<10;e++)this.game.board[t][e]=null;this.customizationTarget=null,this.renderer.clearHighlights(),this.renderer.renderBoard(this.game),document.getElementById("customizationModal").style.display="none"}clearFile(t){for(let e=0;e<10;e++)this.game.board[e][t]=null;this.customizationTarget=null,this.renderer.clearHighlights(),this.renderer.renderBoard(this.game),document.getElementById("customizationModal").style.display="none"}clearAll(){for(let t=0;t<10;t++)for(let e=0;e<10;e++)this.game.board[t][e]=null;this.customizationTarget=null,this.renderer.clearHighlights(),this.renderer.renderBoard(this.game),document.getElementById("customizationModal").style.display="none"}undoCustomization(){this.customizationTarget&&this.placeCustomPiece(this.customizationTarget.file,this.customizationTarget.rank,null)}clearSquare(){this.customizationTarget&&this.placeCustomPiece(this.customizationTarget.file,this.customizationTarget.rank,null)}mirrorBoard(){for(let t=0;t<5;t++)for(let e=0;e<10;e++){const o=this.game.board[t][e];if(o){const i=9-t;this.game.board[i][e]={type:o.type,color:o.color==="white"?"black":"white"}}}this.renderer.renderBoard(this.game)}resetBoard(){this.game.reset(),this.renderer.renderBoard(this.game),this.customizationTarget=null,this.renderer.clearHighlights(),document.getElementById("customizationModal").style.display="none"}changeTheme(){const t=document.getElementById("themeSelector").value,e=["default","light","dark"],i=(e.indexOf(t)+1)%e.length,r=e[i];this.applyTheme(r),document.getElementById("themeSelector").value=r}applyTheme(t){this.currentTheme=t;const e=this.getThemeConfig(t);if(e){const o=document.querySelector(".game-controls");o&&e.elements.buttonBar&&(o.style.backgroundColor=e.elements.buttonBar.background);const i=document.querySelector(".promotion-content");i&&e.elements.promotionModal&&(i.style.backgroundColor=e.elements.promotionModal.background)}}getThemeConfig(t){const e={default:{elements:{buttonBar:{background:"#34495e"},promotionModal:{background:"#34495e"}}},light:{elements:{buttonBar:{background:"#f0d9b5"},promotionModal:{background:"#f0d9b5"}}},dark:{elements:{buttonBar:{background:"#1a1a1a"},promotionModal:{background:"#1a1a1a"}}}};return e[t]||e.default}updateStaticIcons(){const t=b().split(" ").filter(e=>e);t.join(" "),document.querySelectorAll("i[data-icon]").forEach(e=>{const o=e.dataset.icon,i=C(o);e.classList.remove("fa-solid","fa-duotone","fa-sharp","fa-sharp-duotone","fa-regular","fa-light","fa-thin"),t.forEach(r=>e.classList.add(r)),i&&i.length&&(Array.from(e.classList).forEach(s=>{s.startsWith("fa-")&&!s.match(/^fa-(solid|duotone|sharp|sharp-duotone|regular|light|thin)$/)&&e.classList.remove(s)}),i.forEach(s=>{e.classList.add(s)}))})}initializeTooltips(){const{computePosition:t,flip:e,shift:o,offset:i,arrow:r,autoUpdate:s}=FloatingUIDOM;document.querySelectorAll("[title]").forEach(l=>{const a=document.createElement("div");a.className="tooltip",a.textContent=l.title,l.title="",document.body.appendChild(a);const c=document.createElement("div");c.className="tooltip-arrow",a.appendChild(c);let h;function d(){t(l,a,{placement:"top",middleware:[i(8),e(),o({padding:5})]}).then(({x:y,y:m,placement:v})=>{Object.assign(a.style,{left:`${y}px`,top:`${m}px`})})}let f;function u(){clearTimeout(f),f=setTimeout(()=>{a.classList.add("show"),d(),h=s(l,a,d)},1500)}function k(){clearTimeout(f),a.classList.remove("show"),h==null||h()}l.addEventListener("mouseenter",u),l.addEventListener("mouseleave",k)})}}document.addEventListener("DOMContentLoaded",()=>{new B,"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(g=>{console.log("ServiceWorker registration successful:",g.scope)}).catch(g=>{console.log("ServiceWorker registration failed:",g)})})});
